{% extends 'base/base.html' %}

{% block title %}ê²Œì‹œê¸€ ë° ëŒ“ê¸€{% endblock %}

{% block content %}
<div class="max-full bg-white min-h-screen">
    <!-- ê²Œì‹œê¸€ ì˜ì—­ -->
    <div class="rounded-lg shadow-md p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
                <div>
                    <span class="font-semibold">ìŠ¤í°ì§€ë°¥</span>
                    <span class="text-gray-500 text-sm">ì²­ë¼ 35â€¢5ë¶„ ì „</span>
                </div>
            </div>
            <button class="text-gray-500 hover:text-gray-700">â‹®</button>
        </div>
        <h2 class="text-xl font-bold mb-3">{{ post.title|escape }}</h2>
        <p class="text-gray-700 mb-4">{{ post.content|escape }}</p>
        <div class="flex items-center gap-4 text-gray-600">
            <span class="hover:text-blue-500 cursor-pointer">ğŸ‘ 1</span>
            <span class="hover:text-blue-500 cursor-pointer">ğŸ’¬ 1</span>
            <span class="hover:text-blue-500 cursor-pointer">ğŸ”– 1</span>
        </div>
    </div>
    
    <!-- ëŒ“ê¸€ ì˜ì—­ -->
    <div class="space-y-4">
        <!-- ëŒ“ê¸€ 1 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
                    <div>
                        <span class="font-semibold">ëš±ì´</span>
                        <span class="text-gray-500 text-sm">ì²­ë¼ 35â€¢5ë¶„ ì „</span>
                    </div>
                </div>
                <button class="text-gray-500 hover:text-gray-700">â‹®</button>
            </div>
            <p class="text-gray-700 mb-3">ê°œë³„ ì‚¬ìš©ë£Œ(ë‚œë°©/ìˆ˜ë„/ì˜¨ìˆ˜/ì „ê¸°) ì œì™¸í•˜ë©´, 9~11ë§Œì› ë‚˜ì™€ìš”.</p>
            <div class="flex items-center gap-4 text-gray-600">
                <span class="hover:text-blue-500 cursor-pointer">ğŸ‘ 1</span>
                <span class="hover:text-blue-500 cursor-pointer">ğŸ’¬ 0</span>
                <button class="text-blue-500 hover:text-blue-600" onclick="toggleReplyBox(this)">ë‹µê¸€ ì“°ê¸°</button>
            </div>
            
            <!-- ë‹µê¸€ ì»¨í…Œì´ë„ˆ -->
            <div class="reply-container mt-3"></div>
            
            <!-- ë‹µê¸€ ì…ë ¥ì°½ -->
            <div class="reply-box hidden mt-4 bg-gray-50 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
                    <span class="font-semibold">ì‚¬ìš©ì</span>
                </div>
                <input type="text" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" 
                        class="w-full p-2 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex justify-end gap-2">
                    <button class="px-4 py-2 text-gray-500 hover:text-gray-700" 
                            onclick="toggleReplyBox(this)">ì·¨ì†Œ</button>
                    <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" 
                            onclick="addReply(this)">ë“±ë¡</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ëŒ“ê¸€ ì…ë ¥ì°½ -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <div class="flex items-center gap-2 mb-3">
            <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
            <span class="font-semibold">ì‚¬ìš©ì</span>
        </div>
        <form id="commentForm" method="POST">
            {% csrf_token %}
            <input type="text" 
                    name="comment" 
                    maxlength="1000"
                    pattern="[ê°€-í£a-zA-Z0-9\s!?.,]+"
                    placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
                    class="w-full p-2 border rounded-lg">
        </form>
        <div class="flex justify-end gap-2">
            <button class="px-4 py-2 text-gray-500 hover:text-gray-700">ì·¨ì†Œ</button>
            <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ë“±ë¡</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    window.isAuthenticated = '{{ request.user.is_authenticated|yesno:"true,false" }}' === 'true';

    function toggleReplyBox(button) {
        if (!window.isAuthenticated) {
            alert('ë‹µê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = "{% url 'login' %}?next=" + encodeURIComponent(window.location.pathname);
            return;
        }

        const comment = button.closest('.bg-white');
        const replyBox = comment.querySelector('.reply-box');
        const replyInput = replyBox.querySelector('input');
        
        if (replyBox) {
            replyBox.classList.toggle('hidden');
            if (!replyBox.classList.contains('hidden')) {
                replyInput.focus();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const commentInput = document.querySelector('input[placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"]');
        const replyContainers = document.querySelectorAll('.reply-container');
        
        // ì„¸ì…˜ì—ì„œ ì„ì‹œ ì €ì¥ëœ ëŒ“ê¸€ ë³µì›
        const savedComment = sessionStorage.getItem('tempComment');
        if (savedComment) {
            commentInput.value = savedComment;
        }

        // ì…ë ¥ê°’ ê²€ì¦ í•¨ìˆ˜
        function validateInput(input) {
            const pattern = /^[ê°€-í£a-zA-Z0-9\s!?.,]+$/;
            return pattern.test(input) && input.length <= 1000;
        }

        // ëŒ“ê¸€ ì‘ì„± ì²˜ë¦¬
        async function handleComment(action, commentId = null) {
            try {
                const content = commentInput.value.trim();
                if (!validateInput(content)) {
                    throw new Error('Invalid input');
                }

                // ì•”í˜¸í™”ëœ ì„ì‹œ ì €ì¥
                const encryptedContent = encryptData(content);
                sessionStorage.setItem('tempComment', encryptedContent);

                const response = await fetch('/api/comments/', {
                    method: action === 'create' ? 'POST' : 'PUT',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        post_id: '{{ post.id }}',
                        comment_id: commentId
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                sessionStorage.removeItem('tempComment');
                
                // XSS ë°©ì§€ë¥¼ ìœ„í•œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                updateCommentUI(escapeHtml(data));
                
            } catch (error) {
                console.error('Error:', error);
                alert('ëŒ“ê¸€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ë°ì´í„° ì•”í˜¸í™”/ë³µí˜¸í™” í•¨ìˆ˜
        function encryptData(data) {
            return btoa(JSON.stringify(data));
        }
        
        function decryptData(encrypted) {
            return JSON.parse(atob(encrypted));
        }

        // addReply í•¨ìˆ˜ ìˆ˜ì •
        window.addReply = async function(button) {
            const comment = button.closest('.bg-white');
            const replyInput = comment.querySelector('.reply-box input');
            const replyText = replyInput.value.trim();
            const commentId = comment.dataset.commentId;
            
            if (replyText) {
                try {
                    // ë‹µê¸€ ì„ì‹œ ì €ì¥
                    sessionStorage.setItem(`tempReply_${commentId}`, encryptData(replyText));

                    const response = await fetch('/api/replies/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            content: replyText,
                            comment_id: commentId
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // ì„±ê³µ ì‹œ ì„ì‹œ ë°ì´í„° ì‚­ì œ
                        sessionStorage.removeItem(`tempReply_${commentId}`);
                        
                        // UI ì—…ë°ì´íŠ¸
                        updateReplyUI(comment, data);
                        replyInput.value = '';
                        toggleReplyBox(button);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('ë‹µê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        };

        // í˜ì´ì§€ ì´íƒˆ ì‹œ ì„ì‹œ ì €ì¥
        window.addEventListener('beforeunload', function() {
            // ë©”ì¸ ëŒ“ê¸€ ì„ì‹œ ì €ì¥
            if (commentInput.value.trim()) {
                sessionStorage.setItem('tempComment', commentInput.value);
            }

            // ì—´ë ¤ìˆëŠ” ë‹µê¸€ì°½ì˜ ë‚´ìš© ì„ì‹œ ì €ì¥
            document.querySelectorAll('.reply-box:not(.hidden)').forEach(box => {
                const input = box.querySelector('input');
                const commentId = box.closest('.bg-white').dataset.commentId;
                if (input.value.trim()) {
                    sessionStorage.setItem(`tempReply_${commentId}`, input.value);
                }
            });
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì‹œ ë³´ì•ˆ ì²˜ë¦¬
        document.querySelectorAll('button[data-action]').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const action = button.dataset.action;
                if (!['create', 'update', 'delete'].includes(action)) {
                    console.error('Invalid action');
                    return;
                }
                handleComment(action, button.dataset.commentId);
            });
        });
    });
</script>
{% endblock %}