{% extends 'base/base.html' %}

{% block title %}ë™ ì„ íƒ í™”ë©´{% endblock %}

{% block content %}
<!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì»´í¬ë„ŒíŠ¸ -->
<div id="toast" class="hidden fixed top-4 right-4 z-50">
    <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span>ì§€ë„ë¥¼ ë” í™•ëŒ€í•œ í›„ ë§¤ë¬¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</span>
    </div>
</div>
<!-- âœ… ë§¤ë¬¼ ì¢…ë¥˜ ë° ê±°ë˜ ìœ í˜• ì„ íƒ -->
<div class="w-full bg-white -bottom-3 shadow py-3 flex justify-center gap-6">
    <div class="flex gap-3">
        <div class="relative">
            <select id="district-select" class="appearance-none w-40 py-2.5 px-4 pr-10 text-sm bg-white border border-gray-300 rounded-lg hover:border-blue-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200">
                <option value="">êµ¬ ì„ íƒ</option>
                {% for district in districts.keys %}
                    <option value="{{ district }}" {% if district == selected_district %}selected{% endif %}>
                        {{ district }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="relative">
            <select id="dong-select" class="appearance-none w-40 py-2.5 px-4 pr-10 text-sm bg-white border border-gray-300 rounded-lg hover:border-blue-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200">
                <option value="">ë™ ì„ íƒ</option>
                {% for dong in selected_district_dongs %}
                    <option value="{{ dong }}" {% if dong == selected_dong %}selected{% endif %}>
                        {{ dong }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="relative">
        <button id="conditionsButton"
                class="w-40 flex items-center justify-between py-2.5 px-4 text-sm bg-white border border-gray-300 rounded-lg hover:border-blue-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200">
            <span>ë§¤ë¬¼ ì¡°ê±´</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
        
        <div id="conditionsPanel" class="hidden absolute top-full left-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-sm font-medium text-gray-800 mb-3">ë§¤ë¬¼ ì¢…ë¥˜</h3>
                <div class="flex gap-3">
                    <button class="filter-btn flex-1 py-2.5 px-4 rounded-lg transition-all duration-200 border border-gray-300
                                    ui-selected bg-blue-500 text-white shadow-md"
                                    data-type="ì „ì²´"
                                    onclick="updateMapFilters('property', 'ì „ì²´')">ì „ì²´</button>
                    <button class="filter-btn flex-1 py-2.5 px-4 rounded-lg transition-all duration-200 border border-gray-300
                                    bg-white text-gray-700 hover:bg-gray-50
                                    ui-selected:bg-blue-500 ui-selected:text-white ui-selected:shadow-md"
                                    data-type="ì›ë£¸"
                                    onclick="updateMapFilters('property', 'ì›ë£¸')">ì›ë£¸</button>
                    <button class="filter-btn flex-1 py-2.5 px-4 rounded-lg transition-all duration-200 border border-gray-300
                                    bg-white text-gray-700 hover:bg-gray-50
                                    ui-selected:bg-blue-500 ui-selected:text-white ui-selected:shadow-md"
                                    data-type="íˆ¬ë£¸"
                                    onclick="updateMapFilters('property', 'íˆ¬ë£¸')">íˆ¬ë£¸</button>
                </div>
            </div>

            <div class="p-4">
                <h3 class="text-sm font-medium text-gray-800 mb-3">ê±°ë˜ ìœ í˜•</h3>
                <div class="flex gap-3">
                    <button class="filter-btn flex-1 py-2.5 px-4 rounded-lg transition-all duration-200 border border-gray-300
                                    ui-selected bg-blue-500 text-white shadow-md"
                                    data-type="ì „ì²´"
                                    onclick="updateMapFilters('transaction', 'ì „ì²´')">ì „ì²´</button>
                    <button class="filter-btn flex-1 py-2.5 px-4 rounded-lg transition-all duration-200 border border-gray-300
                                    bg-white text-gray-700 hover:bg-gray-50
                                    ui-selected:bg-blue-500 ui-selected:text-white ui-selected:shadow-md"
                                    data-type="ì›”ì„¸"
                                    onclick="updateMapFilters('transaction', 'ì›”ì„¸')">ì›”ì„¸</button>
                    <button class="filter-btn flex-1 py-2.5 px-4 rounded-lg transition-all duration-200 border border-gray-300
                                    bg-white text-gray-700 hover:bg-gray-50
                                    ui-selected:bg-blue-500 ui-selected:text-white ui-selected:shadow-md"
                                    data-type="ì „ì„¸"
                                    onclick="updateMapFilters('transaction', 'ì „ì„¸')">ì „ì„¸</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- âœ… ì™¼ìª½ íŒ¨ë„ (ì ‘íŒ ìƒíƒœ) -->
<div id="sidebar" class="fixed left-0 w-12 mt-0 bg-white shadow-md flex flex-col items-center py-3 transition-all duration-300 z-40 h-[calc(100vh-120px)]">
    <!-- ì£¼ë³€ ì •ë³´ ì•„ì´ì½˜ -->
    <button id="toggleSurroundings" class="p-2 rounded-full hover:bg-gray-100 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4" />
        </svg>
    </button>
    <span class="text-xs text-gray-600 font-medium mb-6">ì£¼ë³€ì •ë³´</span>
    
    <!-- ì‹œì„¸ ì •ë³´ ì•„ì´ì½˜ -->
    <button id="togglePrices" class="p-2 rounded-full hover:bg-gray-100 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
    <span class="text-xs text-gray-600 font-medium mb-6">ì‹œì„¸ì •ë³´</span>
    
    <!-- ë²”ì£„ìœ¨ ì•„ì´ì½˜ -->
    <button id="toggleCrime" class="p-2 rounded-full hover:bg-gray-100 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
    </button>
    <span class="text-xs text-gray-600 font-medium mb-6">ë²”ì£„ìœ¨</span>
    
    <!-- ì¸êµ¬ ë¶„ì„ ì•„ì´ì½˜ -->
    <button id="togglePopulation" class="p-2 rounded-full hover:bg-gray-100 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
    </button>
    <span class="text-xs text-gray-600 font-medium mb-6">ì¸êµ¬ë¶„ì„</span>

    <!-- ì£¼ë³€ ê±°ë¦¬ ì •ë³´ ì•„ì´ì½˜ ì¶”ê°€ (ì¸êµ¬ ë¶„ì„ ì•„ì´ì½˜ ìœ„ì—) -->
    <button id="toggleDistance" class="p-2 rounded-full hover:bg-gray-100 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>
    <span class="text-xs text-gray-600 font-medium mb-6">ê±°ë¦¬ì •ë³´</span>
    
    <!-- ë§¤ë¬¼ í™•ì¸ ë²„íŠ¼ (í•˜ë‹¨ì— ê³ ì •) -->
    <div class="mt-auto">
        <button id="checkProperties" 
            class="w-10 h-10 p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors shadow-md flex items-center justify-center"
            disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </button>
        <span class="text-xs text-gray-600 font-medium -mt-1">ë§¤ë¬¼í™•ì¸</span>
    </div>
</div>

<!-- âœ… ì™¼ìª½ íŒ¨ë„ (í™•ì¥ëœ ìƒíƒœ) -->
<div id="surroundingsPanel" class="hidden fixed left-12 w-48 bg-white shadow-md p-3 mt-0 z-40 h-[calc(100vh-120px)]">
    <div class="space-y-3 h-full overflow-y-auto 
                scrollbar-thin scrollbar-track-transparent scrollbar-thumb-slate-200 
                hover:scrollbar-thumb-slate-300">
        <!-- ì¹´í…Œê³ ë¦¬ ë©”ë‰´ -->
        <div class="mt-3">
            <h3 class="text-xs font-medium text-gray-700 mb-2">ì£¼ë³€ ì •ë³´</h3>
            <!-- ì „ì²´ ì„ íƒ ë²„íŠ¼ -->
            <div class="mb-4">
                <button class="category-btn w-full py-2 px-4 mb-4 border border-gray-300 rounded-lg transition-all duration-200
                                bg-white hover:bg-gray-50"
                        onclick="handleCategoryToggle('ALL')">ì „ì²´</button>
            </div>

            <!-- ê³µê³µê¸°ê´€ ë° ì•ˆì „ -->
            <div class="mb-4">
                <h4 class="text-xs font-medium text-gray-600 mb-2">ê³µê³µê¸°ê´€ ë° ì•ˆì „</h4>
                <div class="flex gap-2">
                    <button class="category-btn flex-1 py-2 px-4 text-xs border border-gray-300 rounded-lg transition-all duration-200
                                    ui-not-selected:bg-white ui-not-selected:hover:bg-gray-50
                                    ui-selected:bg-blue-500 ui-selected:text-white ui-selected:shadow-md"
                            onclick="handleCategoryToggle('PO')">ê²½ì°°ì„œ</button>
                    <button class="category-btn flex-1 py-2 px-4 text-xs border border-gray-300 rounded-lg transition-all duration-200
                                    ui-not-selected:bg-white ui-not-selected:hover:bg-gray-50
                                    ui-selected:bg-blue-500 ui-selected:text-white ui-selected:shadow-md"
                            onclick="handleCategoryToggle('CC')">ì£¼ë¯¼ì„¼í„°</button>
                    <button class="category-btn flex-1 py-2 px-4 text-xs border border-gray-300 rounded-lg transition-all duration-200
                                    ui-not-selected:bg-white ui-not-selected:hover:bg-gray-50
                                    ui-selected:bg-blue-500 ui-selected:text-white ui-selected:shadow-md"
                            onclick="handleCategoryToggle('PT')">ìš°ì²´êµ­</button>
                </div>
            </div>

            <!-- ì˜ë£Œ ì‹œì„¤ -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">ì˜ë£Œ ì‹œì„¤</h4>
                <div class="flex gap-2">
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('HP')">ë³‘ì›</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('PH')">ë³´ê±´ì†Œ</button>
                </div>
            </div>

            <!-- í¸ì˜ ì‹œì„¤ -->
            <div class="mb-4">
                <h4 class="text-xs font-medium text-gray-700 mb-2">í¸ì˜ ì‹œì„¤</h4>
                <!-- ì²« ë²ˆì§¸ ì¤„: 3ê°œ ë²„íŠ¼ -->
                <div class="flex gap-2 mb-1.5">
                    <button class="category-btn flex-1 py-2 px-4 text-xs border rounded-lg hover:bg-gray-50 transition-colors" 
                            onclick="handleCategoryToggle('CS')">í¸ì˜ì </button>
                    <button class="category-btn flex-1 py-2 px-4 text-xs border rounded-lg hover:bg-gray-50 transition-colors" 
                            onclick="handleCategoryToggle('EG')">ì „ê¸°ì°¨ ì¶©ì „ì†Œ</button>
                    <button class="category-btn flex-1 py-2 px-4 text-xs border rounded-lg hover:bg-gray-50 transition-colors" 
                            onclick="handleCategoryToggle('GS')">ì£¼ìœ ì†Œ</button>
                </div>
                <!-- ë‘ ë²ˆì§¸ ì¤„: 2ê°œ ë²„íŠ¼ -->
                <div class="flex gap-2">
                    <button class="category-btn flex-1 py-2 px-4 text-xs border rounded-lg hover:bg-gray-50 transition-colors" 
                            onclick="handleCategoryToggle('SL')">ì…€í”„ ì„¸íƒì†Œ</button>
                    <button class="category-btn flex-1 py-2 px-4 text-xs border rounded-lg hover:bg-gray-50 transition-colors" 
                            onclick="handleCategoryToggle('SM')">ë§ˆíŠ¸</button>
                </div>
            </div>

            <!-- êµí†µ ê´€ë ¨ -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">êµí†µ</h4>
                <div class="flex gap-2">
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('BS')">ë²„ìŠ¤ì •ë¥˜ì¥</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('PS')">ê³µì˜ì£¼ì°¨ì¥</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('SB')">ì§€í•˜ì² ì—­</button>
                </div>
            </div>

            <!-- êµìœ¡ ê´€ë ¨ -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">êµìœ¡</h4>
                <div class="flex gap-2">
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('DC')">ì–´ë¦°ì´ì§‘</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('ED')">êµìœ¡ì‹œì„¤</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('SC')">í•™êµ</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('UV')">ëŒ€í•™êµ</button>
                </div>
            </div>

            <!-- ì—¬ê°€ ê´€ë ¨ -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">ì—¬ê°€</h4>
                <div class="flex gap-2">
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('FN')">í”¼íŠ¸ë‹ˆìŠ¤</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('MR')">ìŒì•…ì—°ìŠµì‹¤</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('PR')">PCë°©</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('TT')">ì˜í™”ê´€</button>
                </div>
            </div>

            <!-- ì²´ìœ¡/ê³µì› ê´€ë ¨ -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-gray-700 mb-2">ì²´ìœ¡/ê³µì›</h4>
                <div class="flex gap-2">
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('OS')">ì²´ìœ¡ì‹œì„¤</button>
                    <button class="category-btn w-full py-2 px-4 border rounded-lg hover:bg-gray-50 transition-colors" onclick="handleCategoryToggle('PK')">ê³µì›</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- âœ… ì‹œì„¸ ì •ë³´ íŒ¨ë„ (í™•ì¥ëœ ìƒíƒœ) -->
<div id="pricesPanel" class="hidden fixed left-12 w-48 bg-white shadow-md p-3 mt-0 z-40 h-[calc(100vh-120px)]">
    <div class="space-y-3 h-full overflow-y-auto">
        <h3 class="text-xs font-medium text-gray-700 mb-2">ì‹œì„¸ ì •ë³´</h3>
        <p class="text-sm text-gray-600">ì´ ì§€ì—­ì˜ í‰ê·  ì›”ì„¸ëŠ” 50ë§Œì›ì´ë©°, ì „ì„¸ëŠ” 1ì–µ 5ì²œë§Œì›ì…ë‹ˆë‹¤.</p>
        <!-- ì¶”ê°€ ì‹œì„¸ ì •ë³´ ë‚´ìš© -->
    </div>
</div>

<!-- âœ… ë²”ì£„ìœ¨ íŒ¨ë„ (í™•ì¥ëœ ìƒíƒœ) -->
<div id="crimePanel" class="hidden fixed left-12 w-48 bg-white shadow-md p-3 mt-0 z-40 h-[calc(100vh-120px)]">
    <div class="space-y-3 h-full overflow-y-auto">
        <h3 class="text-xs font-medium text-gray-700 mb-2">ë²”ì£„ìœ¨ ì •ë³´</h3>
        <p class="text-sm text-gray-600">ì´ ì§€ì—­ì˜ 5ëŒ€ ë²”ì£„ ë°œìƒë¥ ì€ ì„œìš¸ì‹œ í‰ê· ë³´ë‹¤ 20% ë‚®ìŠµë‹ˆë‹¤.</p>
        <!-- ì¶”ê°€ ë²”ì£„ìœ¨ ì •ë³´ ë‚´ìš© -->
    </div>
</div>

<!-- âœ… ì¸êµ¬ ë¶„ì„ íŒ¨ë„ (í™•ì¥ëœ ìƒíƒœ) -->
<div id="populationPanel" class="hidden fixed left-12 w-48 bg-white shadow-md p-3 mt-0 z-40 h-[calc(100vh-120px)]">
    <div class="space-y-3 h-full overflow-y-auto">
        <h3 class="text-xs font-medium text-gray-700 mb-2">ì¸êµ¬ ë¶„ì„</h3>
        <p class="text-sm text-gray-600">ì´ ì§€ì—­ì€ 20-30ëŒ€ ì²­ë…„ ì¸êµ¬ ë¹„ìœ¨ì´ ë†’ìœ¼ë©°, 1ì¸ ê°€êµ¬ê°€ ë§ìŠµë‹ˆë‹¤.</p>
        <!-- ì¶”ê°€ ì¸êµ¬ ë¶„ì„ ë‚´ìš© -->
    </div>
</div>

<!-- âœ… ì£¼ë³€ ê±°ë¦¬ ì •ë³´ íŒ¨ë„ ì¶”ê°€ -->
<div id="distancePanel" class="hidden fixed left-12 bg-white shadow-md p-0 mt-1 z-40"
    style="width: 720px; height: 600px;">
    <div class="h-full w-auto">
        <iframe id="distanceFrame" src="/static/html/Distance_info.html"
                class="border-none"
                style="border:none; width: 100%; height: 100%; display: block; margin: 0 auto;"></iframe>
    </div>
</div>

<!-- âœ… ì§€ë„ ì»¨í…Œì´ë„ˆ -->
<div class="fixed left-0 mt-0 overflow-hidden">
    <div class="ml-12 w-[calc(100vw-3rem)] h-[calc(100vh-120px)]">
        <iframe id="mapFrame" src="{% url 'map' %}" class="w-full h-full border-none"></iframe>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const districtSelect = document.getElementById("district-select");
        const dongSelect = document.getElementById("dong-select");
        const mapFrame = document.getElementById("mapFrame");
        let selectedDistrict = sessionStorage.getItem("selectedDistrict");
        let selectedDong = sessionStorage.getItem("selectedDong");

        // êµ¬ ì„ íƒ ì´ë²¤íŠ¸
        districtSelect.addEventListener("change", function () {
            selectedDistrict = this.value;
            sessionStorage.setItem("selectedDistrict", selectedDistrict);

            if (selectedDistrict) {
                fetch(`/listings/get_dongs/?district=${encodeURIComponent(selectedDistrict)}`)
                    .then(response => response.json())
                    .then(data => {
                        dongSelect.innerHTML = "<option value=''>ë™ ì„ íƒ</option>";
                        data.dongs.forEach(dong => {
                            const option = document.createElement("option");
                            option.value = dong;
                            option.textContent = dong;
                            dongSelect.appendChild(option);
                        });

                        dongSelect.disabled = false;
                    })
                    .catch(error => console.error("Error fetching dongs:", error));

                // êµ¬ ì„ íƒ ì‹œ ì§€ë„ ì´ë™
                mapFrame.contentWindow.postMessage({ 
                    type: "moveToLocation", 
                    address: selectedDistrict 
                }, "*");
            }
        });

        // ë™ ì„ íƒ ì´ë²¤íŠ¸
        dongSelect.addEventListener("change", function () {
            selectedDong = this.value;
            sessionStorage.setItem("selectedDong", selectedDong);

            if (selectedDistrict && selectedDong) {
                const fullAddress = `${selectedDistrict} ${selectedDong}`;
                mapFrame.contentWindow.postMessage({ 
                    type: "moveToLocation", 
                    address: fullAddress 
                }, "*");
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì „ ì„ íƒê°’ ë³µì›
        if (selectedDistrict) {
            districtSelect.value = selectedDistrict;
            fetch(`/listings/get_dongs/?district=${encodeURIComponent(selectedDistrict)}`)
                .then(response => response.json())
                .then(data => {
                    dongSelect.innerHTML = "<option value=''>ë™ ì„ íƒ</option>";
                    data.dongs.forEach(dong => {
                        const option = document.createElement("option");
                        option.value = dong;
                        option.textContent = dong;
                        dongSelect.appendChild(option);
                    });
                    if (selectedDong) {
                        dongSelect.value = selectedDong;
                    }
                    dongSelect.disabled = false;
                })
                .catch(error => console.error("Error fetching dongs:", error));
        }

        // ì‚¬ì´ë“œë°” í† ê¸€ ê¸°ëŠ¥ ì¶”ê°€ - ìˆ˜ì •ëœ ë¶€ë¶„
        const sidebar = document.getElementById('sidebar');
        const surroundingsPanel = document.getElementById('surroundingsPanel');
        const pricesPanel = document.getElementById('pricesPanel');
        const crimePanel = document.getElementById('crimePanel');
        const populationPanel = document.getElementById('populationPanel');
        const distancePanel = document.getElementById('distancePanel');
        
        // ëª¨ë“  íŒ¨ë„ ë‹«ê¸° í•¨ìˆ˜ - ë³€ìˆ˜ëª… ìˆ˜ì •
        function closeAllPanels() {
            surroundingsPanel.classList.add('hidden');
            pricesPanel.classList.add('hidden');
            crimePanel.classList.add('hidden');
            populationPanel.classList.add('hidden');
            distancePanel.classList.add('hidden');
        }

        // ì£¼ë³€ ì •ë³´ í† ê¸€
        document.getElementById('toggleSurroundings').addEventListener('click', function(event) {
            event.stopPropagation();
            const isCurrentlyVisible = surroundingsPanel.classList.contains('hidden');
            closeAllPanels();
            if (isCurrentlyVisible) {
                surroundingsPanel.classList.remove('hidden');
            }
            console.log('ì£¼ë³€ ì •ë³´ íŒ¨ë„ í† ê¸€');
        });

        // ì‹œì„¸ ì •ë³´ í† ê¸€
        document.getElementById('togglePrices').addEventListener('click', function(event) {
            event.stopPropagation();
            const isCurrentlyVisible = pricesPanel.classList.contains('hidden');
            closeAllPanels();
            if (isCurrentlyVisible) {
                pricesPanel.classList.remove('hidden');
            }
            console.log('ì‹œì„¸ ì •ë³´ íŒ¨ë„ í† ê¸€');
        });
        
        // ë²”ì£„ìœ¨ í† ê¸€
        document.getElementById('toggleCrime').addEventListener('click', function(event) {
            event.stopPropagation();
            const isCurrentlyVisible = crimePanel.classList.contains('hidden');
            closeAllPanels();
            if (isCurrentlyVisible) {
                crimePanel.classList.remove('hidden');
            }
            console.log('ë²”ì£„ìœ¨ íŒ¨ë„ í† ê¸€');
        });
        
        // ì¸êµ¬ ë¶„ì„ í† ê¸€
        document.getElementById('togglePopulation').addEventListener('click', function(event) {
            event.stopPropagation();
            const isCurrentlyVisible = populationPanel.classList.contains('hidden');
            closeAllPanels();
            if (isCurrentlyVisible) {
                populationPanel.classList.remove('hidden');
            }
            console.log('ì¸êµ¬ ë¶„ì„ íŒ¨ë„ í† ê¸€');
        });

        // ê±°ë¦¬ ì •ë³´ í† ê¸€
        document.getElementById('toggleDistance').addEventListener('click', function(event) {
            event.stopPropagation();
            const isCurrentlyVisible = distancePanel.classList.contains('hidden');
            closeAllPanels();
            if (isCurrentlyVisible) {
                distancePanel.classList.remove('hidden');
            }
            console.log('ê±°ë¦¬ ì •ë³´ íŒ¨ë„ í† ê¸€');
        });
        
        // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ ì‚¬ì´ë“œë°” ìœ ì§€
        const categoryButtons = document.querySelectorAll('.category-btn');
        categoryButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation();
                console.log('ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ë¨');
            });
        });
    });

    const conditionsButton = document.getElementById('conditionsButton');
    const conditionsPanel = document.getElementById('conditionsPanel');
    const arrowIcon = document.querySelector('svg');
    // ì¡°ê±´ ë²„íŠ¼ í´ë¦­ ì‹œ íŒ¨ë„ í† ê¸€
    conditionsButton.addEventListener('click', function(event) {
        event.stopPropagation();
        const isHidden = conditionsPanel.classList.contains('hidden');
        
        conditionsPanel.classList.toggle('hidden');

        if (isHidden) {
            arrowIcon.style.transform = 'rotate(180deg)';
        } else {
            arrowIcon.style.transform = 'rotate(0)';
        }
    });

    // íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', function(event) {
        if (!conditionsButton.contains(event.target) && !conditionsPanel.contains(event.target)) {
            conditionsPanel.classList.add('hidden');
            arrowIcon.style.transform = 'rotate(0)';
        }
    });

    // í•„í„° ë²„íŠ¼ í´ë¦­ ì‹œ íŒ¨ë„ ìœ ì§€
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });
</script>

<script>
    function handleCategoryToggle(category) {
        const mapWindow = document.getElementById('mapFrame').contentWindow;
        const btn = event.target;
        
        if (category === 'ALL') {
            // ì „ì²´ ë²„íŠ¼ í´ë¦­ ì‹œ
            const allButtons = document.querySelectorAll('.category-btn');
            const isActivating = !btn.classList.contains('active');
            
            // ì „ì²´ ë²„íŠ¼ì„ í¬í•¨í•œ ëª¨ë“  ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ ë³€ê²½
            allButtons.forEach(button => {
                if (isActivating) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // ì§€ë„ì— ì „ì²´ ì¹´í…Œê³ ë¦¬ í† ê¸€ ì ìš©
            mapWindow.toggleAllCategories();
        } else {
            // ê°œë³„ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ
            btn.classList.toggle('active');
            mapWindow.toggleCategory(category, btn);
            
            // ëª¨ë“  ê°œë³„ ë²„íŠ¼ì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
            const categoryButtons = document.querySelectorAll('.category-btn:not([onclick="handleCategoryToggle(\'ALL\')"])');
            const allButton = document.querySelector('.category-btn[onclick="handleCategoryToggle(\'ALL\')"]');
            const allActive = Array.from(categoryButtons).every(button => button.classList.contains('active'));
            
            // ì „ì²´ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (allActive) {
                allButton.classList.add('active');
            } else {
                allButton.classList.remove('active');
            }
        }
    }
</script>

<script>
    function updateMapFilters(filterType, value) {
        const mapFrame = document.getElementById('mapFrame');
        
        // iframeì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (!mapFrame.contentWindow) {
            console.error("âŒ mapFrameì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        // í•´ë‹¹ í•„í„° ê·¸ë£¹ì˜ ëª¨ë“  ë²„íŠ¼ ì„ íƒ í•´ì œ
        const buttons = document.querySelectorAll(`[data-type][onclick*="updateMapFilters('${filterType}"]`);
        buttons.forEach(btn => {
            btn.classList.remove('ui-selected', 'bg-blue-500', 'text-white', 'shadow-md');
            btn.classList.add('bg-white', 'text-gray-700');
        });

        // í´ë¦­ëœ ë²„íŠ¼ ì„ íƒ ìƒíƒœë¡œ ë³€ê²½
        const clickedButton = event ? event.currentTarget : 
            document.querySelector(`[data-type="ì „ì²´"][onclick*="updateMapFilters('${filterType}"]`);
        clickedButton.classList.remove('bg-white', 'text-gray-700');
        clickedButton.classList.add('ui-selected', 'bg-blue-500', 'text-white', 'shadow-md');

        // ì„ íƒ ìƒíƒœ ì €ì¥
        sessionStorage.setItem(`selected_${filterType}`, value);

        // iframe ë¡œë“œ ì™„ë£Œ í›„ í•„í„° ì ìš©
        if (mapFrame.contentWindow.setPropertyFilter && mapFrame.contentWindow.setTransactionFilter) {
            if (filterType === 'property') {
                mapFrame.contentWindow.setPropertyFilter(value);
            } else {
                mapFrame.contentWindow.setTransactionFilter(value);
            }
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì „ ì„ íƒ ìƒíƒœ ë³µì› ë˜ëŠ” ê¸°ë³¸ê°’('ì „ì²´') ì„¤ì •
    document.addEventListener('DOMContentLoaded', function() {
        const mapFrame = document.getElementById('mapFrame');
        
        // iframe ë¡œë“œ ì™„ë£Œ í›„ í•„í„° ìƒíƒœ ë³µì›
        mapFrame.addEventListener('load', function() {
            const savedProperty = sessionStorage.getItem('selected_property') || 'ì „ì²´';
            const savedTransaction = sessionStorage.getItem('selected_transaction') || 'ì „ì²´';
            
            // ì´ë²¤íŠ¸ ì—†ì´ ì§ì ‘ 'ì „ì²´' ë²„íŠ¼ ì„ íƒ
            updateMapFilters('property', savedProperty);
            updateMapFilters('transaction', savedTransaction);
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const mapFrame = document.getElementById("mapFrame");
    
        // âœ… iframeì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë„ë¡ ì´ë²¤íŠ¸ ì¶”ê°€
        mapFrame.addEventListener("load", function () {
            console.log("ğŸŸ¢ iframe(mapFrame) ë¡œë“œ ì™„ë£Œ!");
            sendLocationToMap();
        });
    });
    
    function sendLocationToMap() {
        const mapFrame = document.getElementById("mapFrame");
    
        if (!mapFrame.contentWindow) {
            console.error("âŒ mapFrame.contentWindowê°€ nullì…ë‹ˆë‹¤! iframeì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê°€ëŠ¥ì„±ì´ í¼.");
            return;
        }
    
        let selectedDistrict = decodeURIComponent(sessionStorage.getItem("selectedDistrict"));
        let selectedDong = decodeURIComponent(sessionStorage.getItem("selectedDong"));
        let type = decodeURIComponent(sessionStorage.getItem("type"));
    
        console.log("ğŸ“Œ ë™ì„ íƒí™”ë©´ - ì €ì¥ëœ êµ¬:", selectedDistrict);
        console.log("ğŸ“Œ ë™ì„ íƒí™”ë©´ - ì €ì¥ëœ ë™:", selectedDong);
        console.log("ğŸ“Œ ë™ì„ íƒí™”ë©´ - ì €ì¥ëœ íƒ€ì…:", type);
    
        if (selectedDistrict && selectedDong && type === 'moveToLocation') {
            const fullAddress = `${selectedDistrict} ${selectedDong}`;
            console.log("ğŸ“¤ ì§€ë„ì— ë©”ì‹œì§€ ì „ì†¡ (iframe ì™„ì „ ë¡œë“œ í›„): ", fullAddress);
    
            mapFrame.contentWindow.postMessage({
                type: "moveToLocation",
                address: fullAddress 
            }, "*");

            // ë©”ì‹œì§€ ì „ì†¡ í›„ sessionStorage ì´ˆê¸°í™”
            sessionStorage.removeItem("selectedDistrict");
            sessionStorage.removeItem("selectedDong");
            sessionStorage.removeItem("type");
        }
        else {
            mapFrame.contentWindow.postMessage({
                type: 'initializeMap',
            }, '*');

            // ë©”ì‹œì§€ ì „ì†¡ í›„ sessionStorage ì´ˆê¸°í™”
            sessionStorage.removeItem("selectedDistrict");
            sessionStorage.removeItem("selectedDong");
            sessionStorage.removeItem("type");
        }
    }
</script>

<script>
    let clusterCenter = null;
    let mapLevel = null;
    // let allClustersData = [];  // ëª¨ë“  í´ëŸ¬ìŠ¤í„° ì •ë³´ë¥¼ ì €ì¥í•  ë°°ì—´

    // // iframeìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹  ë¶€ë¶„ ìˆ˜ì •
    // window.addEventListener('message', function(event) {
    //     if (event.data.type === 'clusterCenter') {
    //         clusterCenter = event.data.center;
    //         mapLevel = clusterCenter.level;
            
    //         const checkButton = document.getElementById('checkProperties');
    //         checkButton.disabled = false;
    //         checkButton.classList.remove('opacity-50');
            
    //         if (mapLevel > 4) {
    //             showToast();
    //             return;
    //         }
            
    //         checkButton.classList.add('animate-pulse');
    //         setTimeout(() => {
    //             checkButton.classList.remove('animate-pulse');
    //         }, 2000);
    //     } 
    //     else if (event.data.type === 'saveCluster') {
    //         const clusterData = event.data.cluster;
            
    //         // ì„œë²„ë¡œ í´ëŸ¬ìŠ¤í„° ë°ì´í„° ì „ì†¡
    //         saveClustersToCSV(clusterData);
    //     }
    // });

    // // í´ëŸ¬ìŠ¤í„° ì •ë³´ë¥¼ í™œìš©í•œ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì˜ˆì‹œ
    // function updateClusterInfo(clusters) {
    //     const totalClusters = clusters.length;
    //     const totalMarkers = clusters.reduce((sum, cluster) => sum + cluster.count, 0);
        
    //     console.log(`ì´ í´ëŸ¬ìŠ¤í„° ìˆ˜: ${totalClusters}`);
    //     console.log(`ì´ ë§¤ë¬¼ ìˆ˜: ${totalMarkers}`);
        
    //     // ì—¬ê¸°ì— UI ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
    // }

    function showToast() {
        const toast = document.getElementById('toast');
        console.log('toast element:', toast);
        toast.classList.remove('hidden');
        toast.classList.add('animate-fade-in-down');
        
        setTimeout(() => {
            toast.classList.add('animate-fade-out-up');
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('animate-fade-in-down', 'animate-fade-out-up');
            }, 300);
        }, 3000);
    }

    // ë§¤ë¬¼ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('checkProperties').addEventListener('click', function() {
        if (clusterCenter) {
            if (mapLevel > 4) {
                showToast();
                return;
            }
            // í˜„ì¬ ì„ íƒëœ í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
            const selectedProperty = sessionStorage.getItem('selected_property') || 'ì „ì²´';
            const selectedTransaction = sessionStorage.getItem('selected_transaction') || 'ì „ì²´';
            
            // ë„¤ì´ë²„ ë¶€ë™ì‚° íŒŒë¼ë¯¸í„° ì„¤ì •
            let propertyType = '';
            switch(selectedProperty) {
                case 'ì›ë£¸':
                    propertyType = 'OR';  // ì›ë£¸
                    break;
                case 'íˆ¬ë£¸':
                    propertyType = 'TR';  // íˆ¬ë£¸
                    break;
                default:
                    propertyType = 'OR:TR';  // ì „ì²´ (ì›ë£¸+íˆ¬ë£¸)
            }

            let transactionType = '';
            switch(selectedTransaction) {
                case 'ì›”ì„¸':
                    transactionType = 'RENT';  // ì›”ì„¸
                    break;
                case 'ì „ì„¸':
                    transactionType = 'JEONSE';  // ì „ì„¸
                    break;
                default:
                    transactionType = 'RENT:JEONSE';  // ì „ì²´ (ì›”ì„¸+ì „ì„¸)
            }

            const naverLandUrl = `https://new.land.naver.com/rooms?` + 
                `ms=${clusterCenter.lat},${clusterCenter.lng},16&` +
                `type=${transactionType}&` +
                `roomType=${propertyType}&` +
                `aa=SMALLSPCRENT`;
            
            console.log("ğŸ” ë„¤ì´ë²„ ë¶€ë™ì‚° URL:", naverLandUrl);
            
            window.open(naverLandUrl, '_blank');
        } else {
            alert('ë¨¼ì € ì§€ë„ì—ì„œ í´ëŸ¬ìŠ¤í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
    });
</script>
<!-- 
<script>
    // CSV ì €ì¥ í•¨ìˆ˜ ìˆ˜ì •
    function saveClustersToCSV(clusters) {
        fetch('/listings/save_clusters/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                clusters: clusters  // í´ëŸ¬ìŠ¤í„° ë°°ì—´ ì „ì²´ ì „ì†¡
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('í´ëŸ¬ìŠ¤í„° ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                console.error('í´ëŸ¬ìŠ¤í„° ì €ì¥ ì‹¤íŒ¨:', data.error);
            }
        })
        .catch(error => console.error('Error saving clusters:', error));
    }

    // CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script> -->
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/filters.js"></script>
<script>
    // ê¸°ì¡´ JavaScript ì½”ë“œë“¤...
</script>
{% endblock %}