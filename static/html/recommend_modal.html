<!-- ✅ 추천 모달 -->
<div id="recommendModal" class="fixed left-12 inset-y-0 bg-white shadow-2xl z-[999999] flex flex-col w-[650px]">
    <div class="bg-white h-full w-full flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">AI 매물 추천</h2>
            <div class="flex gap-2">
                <button id="minimizeRecommendModal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                </button>
                <button id="closeRecommendModal" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto">
            <div class="p-6">
                <!-- 추천 페이지 1 -->
                <div id="recommendPage1">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">필수 정보</h2>
                    
                    <!-- 나이 입력 -->
                    <div class="mb-4">
                        <label for="id_age" class="block font-medium mb-2">나이: <span class="text-red-500">*</span></label>
                        <input type="number" name="age" id="id_age" required 
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- 성별 선택 -->
                    <div class="mb-4">
                        <label class="block font-medium mb-2">성별: <span class="text-red-500">*</span></label>
                        <div class="flex gap-4">
                            <label class="flex-1">
                                <input type="radio" name="gender" value="male" class="hidden peer" required>
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-blue-500 peer-checked:text-white cursor-pointer">
                                    남성
                                </div>
                            </label>
                            <label class="flex-1">
                                <input type="radio" name="gender" value="female" class="hidden peer">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-blue-500 peer-checked:text-white cursor-pointer">
                                    여성
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 선호 편의시설 선택 -->
                    <div class="mb-4">
                        <label class="block font-medium mb-2">선호하는 편의시설 (우선순위대로 선택): <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-1 border rounded-lg" id="facilitySelection">
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="SB">지하철</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="BS">버스정류장</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="PK_ST">주차장</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="GS">편의점</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="EL_ST">전기 충전소</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="GS_ST">주유소</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="SM">마트</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="SL">셀프 빨래방</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="HP">병원</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="PO">경찰서</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="PHC">보건소</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="UNIV">대학교</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="SCH">학교</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="EDU">교육기관</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="DYC">어린이집</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="PK">공원</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="FIT">운동시설</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="THT">영화관</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="KTV">노래방</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="PCR">PC방</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="SPT">야외 스포츠</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="TAX">세무서</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="PST">우체국</div>
                            <div class="facility-item p-2 border rounded-lg cursor-pointer hover:bg-gray-50" data-value="COM">주민센터</div>
                        </div>
                        <input type="hidden" name="preferred_facilities" id="preferred_facilities" required>
                        <div id="selectedFacilities" class="mt-2 text-sm text-gray-600"></div>
                    </div>

                    <h2 class="text-lg font-semibold text-gray-700 mb-4">선택 정보</h2>

                    <!-- 주 이동수단 -->
                    <div class="mb-4">
                        <label class="block font-medium mb-2">주 이용 교통수단:</label>
                        <div class="flex gap-4">
                            <label class="flex-1">
                                <input type="radio" name="transport" value="bus" class="hidden peer">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-blue-500 peer-checked:text-white cursor-pointer">
                                    버스
                                </div>
                            </label>
                            <label class="flex-1">
                                <input type="radio" name="transport" value="subway" class="hidden peer">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-blue-500 peer-checked:text-white cursor-pointer">
                                    지하철
                                </div>
                            </label>
                            <label class="flex-1">
                                <input type="radio" name="transport" value="car" class="hidden peer">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-blue-500 peer-checked:text-white cursor-pointer">
                                    자가용
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 희망 거주 지역 -->
                    <div class="mb-4">
                        <label class="block font-medium mb-2">희망 거주 지역: <span class="text-red-500">* 구 선택 필수</span></label>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <select id="recommend-district-select" name="desired_district" required
                                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">구 선택</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <select id="recommend-dong-select" name="desired_dong"
                                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">동 선택 (선택사항)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button id="nextToPage2" 
                            class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors mt-8">
                        다음 페이지로
                    </button>
                </div>

                <!-- 추천 페이지 2 -->
                <div id="recommendPage2" class="hidden">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">필수 정보</h2>

                    <!-- 선호 매물 정보 -->
                    <div class="mb-4">
                        <label class="block font-medium mb-2">선호하는 매물 형태: <span class="text-red-500">*</span></label>
                        <div class="flex gap-4">
                            <label class="flex-1">
                                <input type="radio" name="property_type" value="jeonse" class="hidden peer" required>
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-blue-500 peer-checked:text-white cursor-pointer">
                                    전세
                                </div>
                            </label>
                            <label class="flex-1">
                                <input type="radio" name="property_type" value="monthly" class="hidden peer">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-blue-500 peer-checked:text-white cursor-pointer">
                                    월세
                                </div>
                            </label>
                        </div>
                    </div>

                    <h2 class="text-lg font-semibold text-gray-700 mb-4">선택 정보</h2>

                    <!-- 범죄 민감도 -->
                    <div class="mb-4">
                        <label class="block font-medium mb-2">범죄 민감도:</label>
                        <div class="flex items-center gap-4">
                            <input type="range" name="crime_sensitivity" min="0" max="5" value="3" 
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="sensitivityValue" class="text-blue-500 font-bold">3</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">0: 민감하지 않음, 5: 매우 민감</p>
                    </div>

                    <!-- 선호 시세 정보 -->
                    <div id="priceRangeSection" class="mb-6">
                        <label class="block font-medium mb-2">선호 시세 범위:</label>
                        <div class="space-y-4" id="jeonseSection">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">전세 보증금 (만원):</label>
                                <div class="flex gap-4">
                                    <input type="number" name="jeonse_deposit_min" placeholder="최소"
                                        class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <span class="self-center">~</span>
                                    <input type="number" name="jeonse_deposit_max" placeholder="최대"
                                        class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4" id="monthlySection" style="display: none;">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">월세 보증금 (만원):</label>
                                <div class="flex gap-4">
                                    <input type="number" name="monthly_deposit_min" placeholder="최소"
                                        class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <span class="self-center">~</span>
                                    <input type="number" name="monthly_deposit_max" placeholder="최대"
                                        class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">월세 (만원):</label>
                                <div class="flex gap-4">
                                    <input type="number" name="monthly_rent_min" placeholder="최소"
                                        class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <span class="self-center">~</span>
                                    <input type="number" name="monthly_rent_max" placeholder="최대"
                                        class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4 mb-6">
                        <button id="backToPage1" 
                                class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            이전 페이지로
                        </button>
                        <button id="submitRecommend" 
                                class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            추천 결과 보기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 모달 컨텐츠 관련 기능만 남김
window.initializeRecommendModal = function() {
    const recommendPage1 = document.getElementById('recommendPage1');
    const recommendPage2 = document.getElementById('recommendPage2');
    const nextToPage2 = document.getElementById('nextToPage2');
    const backToPage1 = document.getElementById('backToPage1');
    const submitRecommend = document.getElementById('submitRecommend');
    const recommendDistrictSelect = document.getElementById('recommend-district-select');
    const recommendDongSelect = document.getElementById('recommend-dong-select');
    const propertyTypeInputs = document.querySelectorAll('input[name="property_type"]');
    const jeonseSection = document.getElementById('jeonseSection');
    const monthlySection = document.getElementById('monthlySection');
    const sensitivityRange = document.querySelector('input[name="crime_sensitivity"]');
    const sensitivityValue = document.getElementById('sensitivityValue');
    const ageInput = document.getElementById('id_age');

    // 나이 입력 제한
    ageInput.addEventListener("input", function() {
        const value = parseInt(this.value);
        if (value < 1) this.value = 1;
        if (value > 150) this.value = 150;
    });

    // 다음 페이지로 이동
    nextToPage2.addEventListener('click', function() {
        // 유효성 검사
        const age = ageInput.value;
        const gender = document.querySelector('input[name="gender"]:checked');
        const facilities = document.getElementById('preferred_facilities').value;
        const district = recommendDistrictSelect.value;
        
        let isValid = true;
        let errorMessage = '';
        
        if (!age) {
            isValid = false;
            errorMessage += '나이를 입력해주세요.\n';
        }
        
        if (!gender) {
            isValid = false;
            errorMessage += '성별을 선택해주세요.\n';
        }
        
        if (!facilities) {
            isValid = false;
            errorMessage += '선호하는 편의시설을 최소 1개 이상 선택해주세요.\n';
        }
        
        if (!district) {
            isValid = false;
            errorMessage += '희망 거주 지역(구)을 선택해주세요.\n';
        }
        
        if (!isValid) {
            alert(errorMessage);
            return;
        }
        
        recommendPage1.classList.add('hidden');
        recommendPage2.classList.remove('hidden');
    });

    // 이전 페이지로 이동
    backToPage1.addEventListener('click', function() {
        recommendPage2.classList.add('hidden');
        recommendPage1.classList.remove('hidden');
    });

    // 선호 매물 형태 선택 시 해당 섹션 표시
    propertyTypeInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value === 'jeonse') {
                jeonseSection.style.display = 'block';
                monthlySection.style.display = 'none';
            } else {
                jeonseSection.style.display = 'none';
                monthlySection.style.display = 'block';
            }
        });
    });

    // 범죄 민감도 값 표시
    sensitivityRange.addEventListener('input', function() {
        sensitivityValue.textContent = this.value;
    });

    // 편의시설 선택
    const facilityItems = document.querySelectorAll('.facility-item');
    const selectedFacilitiesDiv = document.getElementById('selectedFacilities');
    const preferredFacilitiesInput = document.getElementById('preferred_facilities');
    const selectedFacilities = new Set();

    facilityItems.forEach(item => {
        item.addEventListener('click', function() {
            const facilityValue = this.dataset.value;
            
            if (this.classList.contains('selected')) {
                // 선택 해제
                this.classList.remove('selected', 'bg-blue-500', 'text-white');
                selectedFacilities.delete(facilityValue);
            } else {
                // 선택
                this.classList.add('selected', 'bg-blue-500', 'text-white');
                selectedFacilities.add(facilityValue);
            }
            
            // 선택된 시설 목록 업데이트
            preferredFacilitiesInput.value = Array.from(selectedFacilities).join(',');
            updateSelectedFacilitiesDisplay();
        });
    });

    function updateSelectedFacilitiesDisplay() {
        if (selectedFacilities.size > 0) {
            const facilitiesList = Array.from(selectedFacilities).map((facility, index) => {
                const facilityElement = document.querySelector(`[data-value="${facility}"]`);
                return `${index + 1}. ${facilityElement.textContent}`;
            }).join(', ');
            selectedFacilitiesDiv.textContent = `선택된 순서: ${facilitiesList}`;
        } else {
            selectedFacilitiesDiv.textContent = '';
        }
    }

    // 구/동 선택
    fetch('/listings/get_districts/')
        .then(response => response.json())
        .then(data => {
            recommendDistrictSelect.innerHTML = '<option value="">구 선택</option>';
            Object.keys(data.districts).forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                recommendDistrictSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('구 목록 조회 중 오류:', error);
        });

    recommendDistrictSelect.addEventListener('change', function() {
        const selectedDistrict = this.value;
        
        if (selectedDistrict) {
            fetch(`/listings/get_dongs/?district=${encodeURIComponent(selectedDistrict)}`)
                .then(response => response.json())
                .then(data => {
                    recommendDongSelect.innerHTML = '<option value="">동 선택 (선택사항)</option>';
                    data.dongs.forEach(dong => {
                        const option = document.createElement('option');
                        option.value = dong;
                        option.textContent = dong;
                        recommendDongSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('동 목록 조회 중 오류:', error);
                });
        } else {
            recommendDongSelect.innerHTML = '<option value="">동 선택 (선택사항)</option>';
        }
    });

    // 추천 제출
    submitRecommend.addEventListener('click', function() {
        // 유효성 검사
        const propertyType = document.querySelector('input[name="property_type"]:checked');
        
        if (!propertyType) {
            alert('선호하는 매물 형태를 선택해주세요.');
            return;
        }
        
        // 시세 범위 유효성 검사
        if (propertyType.value === 'jeonse') {
            const minDeposit = parseInt(document.querySelector('input[name="jeonse_deposit_min"]').value);
            const maxDeposit = parseInt(document.querySelector('input[name="jeonse_deposit_max"]').value);
            
            if (minDeposit && maxDeposit && minDeposit > maxDeposit) {
                alert("최소 보증금이 최대 보증금보다 클 수 없습니다.");
                return;
            }
        } else {
            const minDeposit = parseInt(document.querySelector('input[name="monthly_deposit_min"]').value);
            const maxDeposit = parseInt(document.querySelector('input[name="monthly_deposit_max"]').value);
            const minRent = parseInt(document.querySelector('input[name="monthly_rent_min"]').value);
            const maxRent = parseInt(document.querySelector('input[name="monthly_rent_max"]').value);
            
            if (minDeposit && maxDeposit && minDeposit > maxDeposit) {
                alert("최소 보증금이 최대 보증금보다 클 수 없습니다.");
                return;
            }
            if (minRent && maxRent && minRent > maxRent) {
                alert("최소 월세가 최대 월세보다 클 수 없습니다.");
                return;
            }
        }
        
        // 폼 데이터 생성
        const formData = new FormData();
        formData.append('age', ageInput.value);
        formData.append('gender', document.querySelector('input[name="gender"]:checked').value);
        formData.append('preferred_facilities', preferredFacilitiesInput.value);
        
        const transport = document.querySelector('input[name="transport"]:checked');
        if (transport) {
            formData.append('transport', transport.value);
        }
        
        formData.append('desired_district', recommendDistrictSelect.value);
        
        const desiredDong = recommendDongSelect.value;
        if (desiredDong) {
            formData.append('desired_dong', desiredDong);
        }
        
        formData.append('property_type', propertyType.value);
        formData.append('crime_sensitivity', sensitivityRange.value);
        
        if (propertyType.value === 'jeonse') {
            const jeonseDepositMin = document.querySelector('input[name="jeonse_deposit_min"]').value;
            const jeonseDepositMax = document.querySelector('input[name="jeonse_deposit_max"]').value;
            
            if (jeonseDepositMin) formData.append('jeonse_deposit_min', jeonseDepositMin);
            if (jeonseDepositMax) formData.append('jeonse_deposit_max', jeonseDepositMax);
        } else {
            const monthlyDepositMin = document.querySelector('input[name="monthly_deposit_min"]').value;
            const monthlyDepositMax = document.querySelector('input[name="monthly_deposit_max"]').value;
            const monthlyRentMin = document.querySelector('input[name="monthly_rent_min"]').value;
            const monthlyRentMax = document.querySelector('input[name="monthly_rent_max"]').value;
            
            if (monthlyDepositMin) formData.append('monthly_deposit_min', monthlyDepositMin);
            if (monthlyDepositMax) formData.append('monthly_deposit_max', monthlyDepositMax);
            if (monthlyRentMin) formData.append('monthly_rent_min', monthlyRentMin);
            if (monthlyRentMax) formData.append('monthly_rent_max', monthlyRentMax);
        }

        // 서버로 데이터 전송
        fetch('/recommendations/recommend/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 추천 결과 처리
                alert('추천이 완료되었습니다!');
                
                // 부모 창의 함수 호출하여 모달 닫기
                if (window.parent && window.parent.closeRecommendModal) {
                    window.parent.closeRecommendModal();
                } else {
                    console.log('완료 후 모달 닫기 처리 필요');
                }
            } else {
                alert('추천 중 오류가 발생했습니다: ' + (data.error || '알 수 없는 오류'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('추천 중 오류가 발생했습니다.');
        });
    });
}

// CSRF 토큰을 가져오는 함수
window.getCookie = function(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 편의시설 항목 스타일 추가
document.head.insertAdjacentHTML('beforeend', `
<style>
    .facility-item {
        transition: all 0.3s ease;
    }
    .facility-item.selected {
        background-color: #3b82f6;
        color: white;
    }
</style>
`);
</script> 