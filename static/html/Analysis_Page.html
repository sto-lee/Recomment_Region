<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ë™ì‚° ë§¤ë¬¼ ì¶”ì²œ ë¶„ì„</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 800px;
            margin: auto;
        }
        .chart-container {
            margin-top: 20px;
            display: none;
        }
        canvas {
            max-width: 100%;
            margin: auto;
        }
        table {
            width: 80%;
            margin: 10px auto;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        .analysis-box {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            text-align: left;
            border-left: 4px solid #4682b4;
        }
        .trend-up {
            color: #008800;
        }
        .trend-down {
            color: #cc0000;
        }
        .highlight {
            font-weight: bold;
            background-color: #ffffcc;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>


<body>
    <h1>ğŸ“Šì¸êµ¬ ë¶„ì„</h1>
    <div class="container">
        <div class="chart-container" id="charts">
            <h3>ìƒì£¼ ì¸êµ¬ vs. ì§ì¥ ì¸êµ¬</h3>
            <canvas id="populationChart"></canvas>
            <div class="analysis-box" id="populationAnalysis">
                <h4>ğŸ“Š ì¸êµ¬ ë™í–¥ ë¶„ì„</h4>
                <p id="populationTrend"></p>
                <p id="populationComparison"></p>
                <p id="populationGrowth"></p>
            </div>
        </div>

        <div class="chart-container" id="genderCharts">
            <h3>ë‚¨ì„± / ì—¬ì„± ì¸êµ¬</h3>
            <canvas id="genderChart"></canvas>
            <div class="analysis-box">
                <h4>ğŸ“Š ì„±ë³„ ì¸êµ¬ ë¶„ì„</h4>
                <p id="genderDifference"></p>
                <p id="genderTrend"></p>
            </div>
        </div>

        <div class="chart-container" id="ageGroupCharts">
            <h3>ì—°ë ¹ë³„ ì¸êµ¬ ë¶„í¬</h3>
            <canvas id="ageGroupChart"></canvas>
            <table id="ageGroupTable">
                <thead>
                    <tr>
                        <th>ì—°ë ¹ëŒ€</th>
                        <th>ì¸êµ¬ìˆ˜</th>
                        <th>ë¹„ìœ¨ (%)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="analysis-box">
                <h4>ğŸ“Š ì—°ë ¹ëŒ€ë³„ ì¸êµ¬ ë¶„ì„</h4>
                <p id="dominantAgeGroup"></p>
                <p id="ageDistribution"></p>
                <p id="ageGroupInsight"></p>
            </div>
        </div>
    </div>

    <script>
        let chartInstance, genderChartInstance, ageGroupChartInstance;
        let colors = {
            "resident_total": "blue",
            "worker_total": "orange",
            "male": "green",
            "female": "red",
            "ageGroup": ["#FF9999", "#FFCC99", "#FFFF99", "#99FF99", "#99CCFF", "#CC99FF"]
        };

// #################################################################################################################################
document.addEventListener("DOMContentLoaded", function() {
    function waitForDongSelect(callback) {
        let neighborhoodSelect = parent.document.getElementById("dong-select");

        if (neighborhoodSelect) {
            callback(neighborhoodSelect);
        } else {
            console.warn("âš ï¸ 'dong-select' ìš”ì†Œê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„ ì¤‘...");
            setTimeout(() => waitForDongSelect(callback), 500);
        }
    }

    waitForDongSelect(function(neighborhoodSelect) {
        console.log("âœ… 'dong-select' ìš”ì†Œê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");

        window.dataset = {}; // âœ… ì „ì—­ ë³€ìˆ˜ ì„ ì–¸

        // âœ… JSON íŒŒì¼ ë¡œë“œ (í•œ ë²ˆë§Œ ìˆ˜í–‰)
        fetch("/static/data/population_data.json")
            .then(response => response.json())
            .then(data => {
                window.dataset = data;

                let savedDong = sessionStorage.getItem("selectedDong");
                if (savedDong) {
                    console.log("ğŸ“Œ ì €ì¥ëœ ë™ ë¶ˆëŸ¬ì˜¤ê¸°:", savedDong);
                    neighborhoodSelect.value = savedDong;
                    updateChartsByDong(savedDong);
                }
            })
            .catch(error => console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ", error));

        // âœ… `dong-select` ê°’ì´ ë³€ê²½ë  ë•Œ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
        neighborhoodSelect.addEventListener("change", function() {
            let selectedDong = neighborhoodSelect.value;

            if (!selectedDong) {
                console.warn("âš ï¸ 'dong-select' ê°’ì´ ë¹„ì–´ ìˆì–´ updateChartsByDong ì‹¤í–‰ ì•ˆí•¨.");
                return;
            }

            sessionStorage.setItem("selectedDong", selectedDong);
            updateChartsByDong(selectedDong);
        });
    });
});

// âœ… ì„ íƒí•œ ë™ì„ ì´ìš©í•˜ì—¬ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateChartsByDong(selectedDong) {
    if (!selectedDong) {
        console.warn("âš ï¸ 'dong-select' ê°’ì´ ì—†ìŠµë‹ˆë‹¤. updateCharts ì‹¤í–‰ ì•ˆí•¨.");
        return;
    }

    let matchedDong = Object.keys(window.dataset).find(dong => dong.includes(selectedDong) || selectedDong.includes(dong));

    if (!matchedDong) {
        console.error("âŒ CSV ë°ì´í„°ì—ì„œ í•´ë‹¹ ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", selectedDong);
        document.querySelectorAll(".chart-container").forEach(el => el.style.display = "none");
        return;
    }

    let data = window.dataset[matchedDong];

    if (!data) {
        console.error("âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. matchedDong:", matchedDong);
        return;
    }

    console.log("âœ… ë§¤ì¹­ëœ ë™ ë°ì´í„°:", matchedDong, data);
    
    document.querySelectorAll(".chart-container").forEach(el => el.style.display = "block");
    updateCharts(data);
}

// #################################################################################################################################
function updateCharts(data) {
    if (!data) {
        console.error("âŒ updateCharts: ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ ì•ˆí•¨.");
        return;
    }

    let chartContainer = document.getElementById('populationChart');

    if (!chartContainer) {
        console.error("âŒ 'populationChart' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    if (window.chartInstance) window.chartInstance.destroy();
    if (window.genderChartInstance) window.genderChartInstance.destroy();
    if (window.ageGroupChartInstance) window.ageGroupChartInstance.destroy();

    /*ìˆ˜ì • ì˜ì—­*/
    // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆë“¤ í‘œì‹œ
    document.querySelectorAll(".chart-container").forEach(el => el.style.display = "block");
    /*ìˆ˜ì • ì˜ì—­*/

    let ctx1 = chartContainer.getContext('2d');
    if (!ctx1) {
        console.error("âŒ 'populationChart' ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    window.chartInstance = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: data.years,
            datasets: [
                { label: "ìƒì£¼ ì¸êµ¬", data: data.resident_total, borderColor: "blue", borderWidth: 3, fill: false },
                { label: "ì§ì¥ ì¸êµ¬", data: data.worker_total, borderColor: "orange", borderWidth: 3, fill: false }
            ]
        }
    });

    // âœ… ë‚¨ì„± vs. ì—¬ì„± ì¸êµ¬ ê·¸ë˜í”„
    let ctx2 = document.getElementById('genderChart')?.getContext('2d');
    if (ctx2) {
        window.genderChartInstance = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: data.years,
                datasets: [
                    { label: "ë‚¨ì„± ì¸êµ¬", data: data.male, borderColor: "green", borderWidth: 3, fill: false },
                    { label: "ì—¬ì„± ì¸êµ¬", data: data.female, borderColor: "red", borderWidth: 3, fill: false }
                ]
            }
        });
    }
    /*ìˆ˜ì • ì˜ì—­*/
    let ctx3 = document.getElementById('ageGroupChart')?.getContext('2d');
    if (ctx3) {
        window.ageGroupChartInstance = new Chart(ctx3, {
            type: 'pie',
            data: {
                labels: ["10ëŒ€", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€", "60ëŒ€ ì´ìƒ"],
                datasets: [{
                    data: data.ageGroups,
                    backgroundColor: colors["ageGroup"],
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    datalabels: {
                        formatter: (value, ctx) => {
                            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            // return `${value}ëª… (${((value / sum) * 100).toFixed(1)}%)`;
                            return `${((value / sum) * 100).toFixed(1)}%`;
                        },
                        color: "#000",
                        font: { weight: "bold", size: 20 },
                        anchor: 'end',
                        align: 'start',
                        offset: 6
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // ë¶„ì„ ë‚´ìš© ì—…ë°ì´íŠ¸ ì¶”ê°€
    analyzePopulationTrend(data);
    analyzeGenderDistribution(data);
    analyzeAgeGroups(data);
    /*ìˆ˜ì • ì˜ì—­*/
}

// #################################################################################################################################

        function analyzePopulationTrend(data) {
            // ìƒì£¼ì¸êµ¬ ìµœê·¼ ì¶”ì„¸ ë¶„ì„
            let residentDiff = data.resident_total[data.resident_total.length-1] - data.resident_total[data.resident_total.length-2];
            let residentTrend = residentDiff > 0 ? "ìƒìŠ¹" : (residentDiff < 0 ? "í•˜ë½" : "ìœ ì§€");
            let residentClass = residentDiff > 0 ? "trend-up" : (residentDiff < 0 ? "trend-down" : "");
            
            // ì§ì¥ì¸êµ¬ ìµœê·¼ ì¶”ì„¸ ë¶„ì„
            let workerDiff = data.worker_total[data.worker_total.length-1] - data.worker_total[data.worker_total.length-2];
            let workerTrend = workerDiff > 0 ? "ìƒìŠ¹" : (workerDiff < 0 ? "í•˜ë½" : "ìœ ì§€");
            let workerClass = workerDiff > 0 ? "trend-up" : (workerDiff < 0 ? "trend-down" : "");
            
            // 5ë…„ ë³€í™”ìœ¨ ê³„ì‚°
            let residentGrowth = ((data.resident_total[data.resident_total.length-1] - data.resident_total[0]) / data.resident_total[0] * 100).toFixed(1);
            let workerGrowth = ((data.worker_total[data.worker_total.length-1] - data.worker_total[0]) / data.worker_total[0] * 100).toFixed(1);
            
            document.getElementById('populationTrend').innerHTML = 
                `ìƒì£¼ ì¸êµ¬ëŠ” ìµœê·¼ <span class="${residentClass}">${residentTrend}</span> ì¶”ì„¸ì´ë©°, ì§ì¥ ì¸êµ¬ëŠ” <span class="${workerClass}">${workerTrend}</span> ì¶”ì„¸ì…ë‹ˆë‹¤.`;
            
            // ìƒì£¼ì¸êµ¬ì™€ ì§ì¥ì¸êµ¬ ë¹„êµ
            let lastYearDiff = data.resident_total[data.resident_total.length-1] - data.worker_total[data.worker_total.length-1];
            let comparisonText = lastYearDiff > 0 ? 
                `ìƒì£¼ ì¸êµ¬(${data.resident_total[data.resident_total.length-1]}ëª…)ê°€ ì§ì¥ ì¸êµ¬(${data.worker_total[data.worker_total.length-1]}ëª…)ë³´ë‹¤ <span class="highlight">${lastYearDiff}ëª…</span> ë” ë§ìŠµë‹ˆë‹¤.` : 
                `ì§ì¥ ì¸êµ¬(${data.worker_total[data.worker_total.length-1]}ëª…)ê°€ ìƒì£¼ ì¸êµ¬(${data.resident_total[data.resident_total.length-1]}ëª…)ë³´ë‹¤ <span class="highlight">${-lastYearDiff}ëª…</span> ë” ë§ìŠµë‹ˆë‹¤.`;
            
            document.getElementById('populationComparison').innerHTML = comparisonText;
            
            document.getElementById('populationGrowth').innerHTML = 
                `ì§€ë‚œ 5ë…„ê°„ ìƒì£¼ ì¸êµ¬ëŠ” <span class="highlight">${residentGrowth}%</span>, ì§ì¥ ì¸êµ¬ëŠ” <span class="highlight">${workerGrowth}%</span> ë³€í™”í–ˆìŠµë‹ˆë‹¤.`;
        }

        function analyzeGenderDistribution(data) {
            // ë‚¨ì„±/ì—¬ì„± ë¹„êµ
            let maleLast = data.male[data.male.length-1];
            let femaleLast = data.female[data.female.length-1];
            let genderDiff = maleLast - femaleLast;
            
            let genderText = genderDiff > 0 ? 
                `ë‚¨ì„± ì¸êµ¬(${maleLast}ëª…)ê°€ ì—¬ì„± ì¸êµ¬(${femaleLast}ëª…)ë³´ë‹¤ <span class="highlight">${genderDiff}ëª…</span> ë” ë§ìŠµë‹ˆë‹¤.` : 
                `ì—¬ì„± ì¸êµ¬(${femaleLast}ëª…)ê°€ ë‚¨ì„± ì¸êµ¬(${maleLast}ëª…)ë³´ë‹¤ <span class="highlight">${-genderDiff}ëª…</span> ë” ë§ìŠµë‹ˆë‹¤.`;
            
            // ì„±ë³„ ì¸êµ¬ ì¶”ì„¸
            let maleDiff = data.male[data.male.length-1] - data.male[data.male.length-2];
            let femaleDiff = data.female[data.female.length-1] - data.female[data.female.length-2];

            let maleTrend = maleDiff > 0 ? "ì¦ê°€" : (maleDiff < 0 ? "ê°ì†Œ" : "ìœ ì§€");
            let femaleTrend = femaleDiff > 0 ? "ì¦ê°€" : (femaleDiff < 0 ? "ê°ì†Œ" : "ìœ ì§€");

            let maleClass = maleDiff > 0 ? "trend-up" : (maleDiff < 0 ? "trend-down" : "");
            let femaleClass = femaleDiff > 0 ? "trend-up" : (femaleDiff < 0 ? "trend-down" : "");

            document.getElementById('genderDifference').innerHTML = genderText;
            document.getElementById('genderTrend').innerHTML = 
                `ìµœê·¼ 1ë…„ê°„ ë‚¨ì„± ì¸êµ¬ëŠ” <span class="${maleClass}">${Math.abs(maleDiff)}ëª… ${maleTrend}</span>í–ˆìœ¼ë©°, ì—¬ì„± ì¸êµ¬ëŠ” <span class="${femaleClass}">${Math.abs(femaleDiff)}ëª… ${femaleTrend}</span>í–ˆìŠµë‹ˆë‹¤.`;
        }

        function analyzeAgeGroups(data) {
            const ageLabels = ["10ëŒ€", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€", "60ëŒ€ ì´ìƒ"];
            const ageGroups = data.ageGroups;
            const total = ageGroups.reduce((sum, current) => sum + current, 0);
            
            // ì—°ë ¹ëŒ€ë³„ í…Œì´ë¸” ìƒì„±
            let tableBody = document.querySelector("#ageGroupTable tbody");
            tableBody.innerHTML = "";
            
            let maxAgeIndex = 0;
            let maxAge = ageGroups[0];
            
            for (let i = 0; i < ageGroups.length; i++) {
                if (ageGroups[i] > maxAge) {
                    maxAge = ageGroups[i];
                    maxAgeIndex = i;
                }
                
                let percentage = ((ageGroups[i] / total) * 100).toFixed(1);
                let row = `<tr>
                    <td>${ageLabels[i]}</td>
                    <td>${ageGroups[i]}ëª…</td>
                    <td>${percentage}%</td>
                </tr>`;
                tableBody.innerHTML += row;
            }
            
            // ê°€ì¥ ë§ì€ ì—°ë ¹ëŒ€ ë° ë¶„í¬ íŠ¹ì§• ë¶„ì„
            document.getElementById('dominantAgeGroup').innerHTML = 
                `ê°€ì¥ ë§ì€ ì—°ë ¹ëŒ€ëŠ” <span class="highlight">${ageLabels[maxAgeIndex]}</span>ë¡œ, ì „ì²´ ì¸êµ¬ì˜ <span class="highlight">${((maxAge / total) * 100).toFixed(1)}%</span>ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤.`;
            
            // ì—°ë ¹ ë¶„í¬ íŠ¹ì„±
            let young = (ageGroups[0] + ageGroups[1]) / total;
            let middle = (ageGroups[2] + ageGroups[3]) / total;
            let old = (ageGroups[4] + ageGroups[5]) / total;
            
            let ageCharacteristic = "";
            if (young > middle && young > old) {
                ageCharacteristic = "ì Šì€ ì¸µ(10-20ëŒ€)ì´ ë§ì€ ì§€ì—­";
            } else if (middle > young && middle > old) {
                ageCharacteristic = "ì¤‘ì¥ë…„ì¸µ(30-40ëŒ€)ì´ ë§ì€ ì§€ì—­";
            } else {
                ageCharacteristic = "ê³ ë ¹ì¸µ(50ëŒ€ ì´ìƒ)ì´ ë§ì€ ì§€ì—­";
            }
            
            document.getElementById('ageDistribution').innerHTML = 
                `10-20ëŒ€: ${((young * 100).toFixed(1))}%, 30-40ëŒ€: ${((middle * 100).toFixed(1))}%, 50ëŒ€ ì´ìƒ: ${((old * 100).toFixed(1))}%`;
            
            document.getElementById('ageGroupInsight').innerHTML = 
                `ì´ ì§€ì—­ì€ <span class="highlight">${ageCharacteristic}</span>ìœ¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.`;
        }
        
    </script>
</body>
</html>