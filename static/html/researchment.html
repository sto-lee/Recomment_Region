<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ì›”ì„¸ ì‹œì„¸ ë¶„ì„</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 800px;
            margin: auto;
        }
        .dropdown-container {
            display: none;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .chart-container {
            display: none;  /* ğŸš€ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            margin-top: 20px;
        }
        #buildingTypeChart, #transactionTypeChart {
            max-width: 300px;
            max-height: 300px;
            margin: auto;
        }
        #no-selection-message {
            display: none;
            font-size: 18px;
            color: gray;
            margin-top: 20px;
        }
        .analysis-text {
            display: none;
            margin-top: 10px;
            font-size: 16px;
            text-align: left;
            padding: 15px;
            border-radius: 8px;
            transition: opacity 0.3s ease-in-out;
            background: linear-gradient(135deg, #ffe6e6, #e6f7ff); /* ğŸ”¥ ë¶€ë“œëŸ¬ìš´ ê·¸ë¼ë””ì–¸íŠ¸ */
            color: #333;
            font-weight: normal;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 6px solid #ff6666; /* ì™¼ìª½ í…Œë‘ë¦¬ì— í¬ì¸íŠ¸ */
        }
        /* âœ… íŠ¹ì • ê°•ì¡°í•  ë¶€ë¶„ë§Œ êµµê²Œ */
        .analysis-text strong {
            font-weight: bold;
            color: black;
        }
        .highlight {
        background-color: #fff53b;  /* ë…¸ë€ìƒ‰ ë°°ê²½ */
        color: #000;               /* ê¸€ììƒ‰ */
        padding: 0 4px;            /* ì¢Œìš° ì—¬ë°± */
        border-radius: 3px;        /* ëª¨ì„œë¦¬ë¥¼ ë‘¥ê¸€ê²Œ */
        font-weight: bold;         /* êµµê²Œ í‘œì‹œ (ì˜µì…˜) */
        }
    </style>
</head>
<body>
    <h2 id="analysis-title">ğŸ“Š ì „ì›”ì„¸ ì‹œì„¸ ë¶„ì„</h2>
    <div class="container">
        <div class="dropdown-container">
            <select id="region-select">
                <option value="">ë²•ì •ë™ëª… ì„ íƒ</option>
            </select>
            <select id="building-select">
                <option value="">ê±´ë¬¼ìš©ë„ ì„ íƒ</option>
            </select>
            <select id="transaction-select">
                <option value="">ê±°ë˜ìœ í˜• ì„ íƒ</option>
            </select>
        </div>
        <p id="no-selection-message">ì¡°íšŒí•˜ê³  ì‹¶ì€ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
        <div class="chart-container" id="chart-area">
            <canvas id="priceTrendChart"></canvas>
        </div>
        <div class="analysis-text" id="rent-analysis"></div>
        <div class="analysis-text" id="deposit-rent-analysis"></div>
        <div class="analysis-text" id="final-price-analysis"></div>
    </div>

    <script>
        let priceChartInstance;
        let buildingChartInstance;
        let transactionChartInstance;
        let csvData = [];

        function loadCSVData() {
            fetch('/static/data/ì„œìš¸_ì „ì›”ì„¸_ì—°ë„ë³„_ë³€í™”_í†µê³„_updated.csv')
                .then(response => response.text())
                .then(data => {
                    parseCSV(data);
                })
                .catch(error => console.error("CSV ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ", error));
        }

        document.addEventListener("DOMContentLoaded", function () {
            const regionSelect = document.getElementById("region-select");

            // âœ… ì‚¬ìš©ìê°€ ì§€ì—­(ë™)ì„ ë³€ê²½í•˜ë©´ sessionStorageì— ì €ì¥
            regionSelect.addEventListener("change", function () {
                sessionStorage.setItem("selectedDong", regionSelect.value);
                console.log("âœ… ë™ ë³€ê²½ë¨:", regionSelect.value);
            });

            // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ sessionStorageì—ì„œ ë™ ë¶ˆëŸ¬ì™€ ì ìš©
            applyStoredSelection();
        });

        function parseCSV(csvText) {
            const rows = csvText.split("\n").map(row => row.split(","));
            const headers = rows.shift().map(header => header.trim());
            csvData = rows.map(row => Object.fromEntries(row.map((val, index) => [headers[index], val.trim()])));
            populateDropdowns();
        }

        function populateDropdowns() {
            const regionSet = new Set();
            const buildingSet = new Set();
            const transactionSet = new Set();
            
            csvData.forEach(row => {
                if (row["ë²•ì •ë™ëª…"] && row["ë²•ì •ë™ëª…"].trim() !== "") {
                    regionSet.add(row["ë²•ì •ë™ëª…"].trim());
                }
                if (row["ê±´ë¬¼ìš©ë„"] && row["ê±´ë¬¼ìš©ë„"].trim() !== "") {
                    buildingSet.add(row["ê±´ë¬¼ìš©ë„"].trim());
                }
                if (row["ê±°ë˜ìœ í˜•"] && row["ê±°ë˜ìœ í˜•"].trim() !== "") {
                    transactionSet.add(row["ê±°ë˜ìœ í˜•"].trim());
                }
            });

            fillDropdown("region-select", regionSet);
            fillDropdown("building-select", buildingSet);
            fillDropdown("transaction-select", transactionSet);

            // âœ… CSV ë°ì´í„°ë¥¼ ë‹¤ ì±„ìš´ í›„ sessionStorage ê°’ ë°˜ì˜
            applyStoredSelection();
        }

        // âœ… ì €ì¥ëœ ë™ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
        function applyStoredSelection() {
            const savedDong = sessionStorage.getItem("selectedDong");
            const regionSelect = document.getElementById("region-select");

            if (savedDong && regionSelect) {
                // ì €ì¥ëœ ë™ì´ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì ìš©
                const options = Array.from(regionSelect.options);
                if (options.some(option => option.value === savedDong)) {
                    regionSelect.value = savedDong;
                    console.log("ğŸ”„ ì €ì¥ëœ ë™ ì ìš©:", savedDong);
                    updateCharts(); // ì„ íƒëœ ê°’ì— ë§ì¶° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                }
            }
        }

        window.addEventListener("message", function (event) {
            if (event.data.type === "updateDong") {
                const selectedDong = event.data.dong;
                console.log("ğŸ“© listings.htmlì—ì„œ ë™ ì •ë³´ ìˆ˜ì‹ :", selectedDong);

                // âœ… ë™ ì˜µì…˜ì´ ë¡œë“œëœ í›„ì— ì ìš©ë˜ë„ë¡ setTimeout ì‚¬ìš©
                function applyDongSelection() {
                    const regionSelect = document.getElementById("region-select");
                    const options = Array.from(regionSelect.options);
                    
                    if (options.length > 1) { // ë“œë¡­ë‹¤ìš´ì´ ì±„ì›Œì¡ŒëŠ”ì§€ í™•ì¸
                        if (options.some(option => option.value === selectedDong)) {
                            regionSelect.value = selectedDong;
                            console.log("âœ… researchment.html - ë™ ìë™ ì ìš©:", selectedDong);
                            updateCharts(); // ì„ íƒëœ ê°’ì— ë§ì¶° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                        }
                    } else {
                        console.warn("âš ï¸ ë™ ëª©ë¡ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•ŠìŒ. 300ms í›„ ë‹¤ì‹œ ì‹œë„...");
                        setTimeout(applyDongSelection, 300); // 300ms í›„ ì¬ì‹œë„
                    }
                }

                applyDongSelection(); // ì²« ì‹¤í–‰
            }

            if (event.data.type === "updateTransaction") {
                const selectedTransaction = event.data.transaction;
                console.log("ğŸ“© listings.htmlì—ì„œ ê±°ë˜ìœ í˜• ì •ë³´ ìˆ˜ì‹ :", selectedTransaction);

                function applyTransactionSelection() {
                    const transactionSelect = document.getElementById("transaction-select");
                    const options = Array.from(transactionSelect.options);

                    if (options.length > 1) { // ë“œë¡­ë‹¤ìš´ì´ ì±„ì›Œì¡ŒëŠ”ì§€ í™•ì¸
                        if (options.some(option => option.value === selectedTransaction)) {
                            transactionSelect.value = selectedTransaction;
                            console.log("âœ… researchment.html - ê±°ë˜ìœ í˜• ìë™ ì ìš©:", selectedTransaction);
                            updateCharts(); // ì„ íƒëœ ê°’ì— ë§ì¶° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                        }
                    } else {
                        console.warn("âš ï¸ ê±°ë˜ìœ í˜• ëª©ë¡ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•ŠìŒ. 300ms í›„ ë‹¤ì‹œ ì‹œë„...");
                        setTimeout(applyTransactionSelection, 300); // 300ms í›„ ì¬ì‹œë„
                    }
                }

                applyTransactionSelection(); // ì²« ì‹¤í–‰
            }
        });

        function checkSelections() {
            const region = document.getElementById("region-select").value;
            
            const noSelectionMessage = document.getElementById("no-selection-message");
            const chartArea = document.getElementById("chart-area");

            if (!region) {
                noSelectionMessage.style.display = "block";
                chartArea.style.display = "none";
            } else {
                noSelectionMessage.style.display = "none";
                chartArea.style.display = "block";
            }
        }

        function fillDropdown(id, dataSet) {
            const dropdown = document.getElementById(id);
            dataSet.forEach(value => {
                const option = document.createElement("option");
                option.value = value;
                option.textContent = value;
                dropdown.appendChild(option);
            });
        }

        function updateCharts() {
            updateAnalysisTitle();
            updatePriceChart();
            updateTextAnalysis();
        }

        function updateAnalysisTitle() {
            const region = document.getElementById("region-select").value || "ì „ì›”ì„¸";
            const building = document.getElementById("building-select").value || "ì‹œì„¸";
            const transaction = document.getElementById("transaction-select").value || "";
            document.getElementById("analysis-title").textContent = `ğŸ“Š ${region} ${building} ${transaction} ë¶„ì„`;
        }

        function updatePriceChart() {
            const chartArea = document.getElementById("chart-area");
            const selectedRegion = document.getElementById("region-select").value;
            const selectedTransaction = document.getElementById("transaction-select").value;

            if (!selectedRegion) {
                chartArea.style.display = "none";
                return;
            }

            if (!selectedTransaction) {
                chartArea.style.display = "none"; // ê±°ë˜ìœ í˜•ì´ ì„ íƒë˜ì§€ ì•Šìœ¼ë©´ ìˆ¨ê¹€
                applyFadeEffect("no-selection-message", "");
                return;
            } else {
                chartArea.style.display = "block"; // ê±°ë˜ìœ í˜•ì´ ì„ íƒë˜ë©´ ê·¸ë˜í”„ í‘œì‹œ
                applyFadeEffect("no-selection-message", "");
            }

            if (priceChartInstance) priceChartInstance.destroy();
            const ctx = document.getElementById("priceTrendChart").getContext("2d");

            const filteredData = csvData.filter(row =>
                row["ë²•ì •ë™ëª…"] === selectedRegion && row["ê±°ë˜ìœ í˜•"] === selectedTransaction
            );

            if (filteredData.length === 0) {
                chartArea.style.display = "none"; // ì„ íƒí•œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê·¸ë˜í”„ ìˆ¨ê¸°ê¸°
                return;
            }

            const years = [...new Set(filteredData.map(row => row["ë…„ë„"]))].sort();
            const depositData = years.map(year => parseFloat(filteredData.find(row => row["ë…„ë„"] === year)?.["ë³´ì¦ê¸ˆ(ë§Œì›)"]) || 0);
            const rentData = years.map(year => parseFloat(filteredData.find(row => row["ë…„ë„"] === year)?.["ì„ëŒ€ë£Œ(ë§Œì›)"]) || 0);

            priceChartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: years,
                    datasets: [
                        { label: "ë³´ì¦ê¸ˆ", data: depositData, borderColor: "blue", borderWidth: 2, fill: false, yAxisID: 'y1' },
                        { label: "ì„ëŒ€ë£Œ", data: rentData, borderColor: "red", borderWidth: 2, fill: false, yAxisID: 'y2' }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y1: { position: 'left', title: { display: true, text: 'ë³´ì¦ê¸ˆ(ë§Œì›)' } },
                        y2: { position: 'right', title: { display: true, text: 'ì„ëŒ€ë£Œ(ë§Œì›)' } }
                    }
                }
            });
        }

        function updateTextAnalysis() {
            const selectedRegion = document.getElementById("region-select").value;
            const selectedTransaction = document.getElementById("transaction-select").value; // ê±°ë˜ìœ í˜• ì„ íƒ ê°’

            if (!selectedRegion) {
                applyFadeEffect("rent-analysis", "ğŸ¡ ì›í•˜ëŠ” ì§€ì—­ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                applyFadeEffect("yearly-trend-analysis", "");
                applyFadeEffect("deposit-rent-analysis", "");
                applyFadeEffect("final-price-analysis", "");
                return;
            }

            // âœ… ê±°ë˜ìœ í˜•ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì•ˆë‚´ ë©”ì‹œì§€ ì¶œë ¥
            if (!selectedTransaction) {
                applyFadeEffect("rent-analysis", "ğŸ“¢ ê±°ë˜ìœ í˜•(ì›”ì„¸/ì „ì„¸)ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!");
                applyFadeEffect("yearly-trend-analysis", "");
                applyFadeEffect("deposit-rent-analysis", "");
                applyFadeEffect("final-price-analysis", "");
                return;
            }

            // ğŸ” ì„ íƒí•œ ì§€ì—­ & ê±°ë˜ìœ í˜• ë°ì´í„°ë§Œ í•„í„°ë§
            const filteredData = csvData.filter(row => row["ë²•ì •ë™ëª…"] === selectedRegion && row["ê±°ë˜ìœ í˜•"] === selectedTransaction);

            if (filteredData.length === 0) {
                applyFadeEffect("rent-analysis", `ğŸ˜¢ í•´ë‹¹ ì§€ì—­ì— ${selectedTransaction} ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                applyFadeEffect("yearly-trend-analysis", "");
                applyFadeEffect("deposit-rent-analysis", "");
                applyFadeEffect("final-price-analysis", "");
                return;
            }

            // âœ… ì‹œì„¸ ë¶„ì„ í…ìŠ¤íŠ¸ ìƒì„±
            let analysisText = generateAnalysisText(filteredData, selectedTransaction);
            applyFadeEffect("rent-analysis", analysisText);

            // âœ… ë³´ì¦ê¸ˆ ëŒ€ë¹„ ì›”ì„¸ ë¹„ìœ¨ ë¶„ì„ (ì›”ì„¸ë§Œ ì ìš©)
            if (selectedTransaction === "ì›”ì„¸") {
                let ratioText = generateDepositRentRatio(filteredData, selectedRegion);
                applyFadeEffect("deposit-rent-analysis", ratioText);
            } else {
                applyFadeEffect("deposit-rent-analysis", "");  // ì „ì„¸ ì„ íƒ ì‹œ ìˆ¨ê¸°ê¸°
            }

            // âœ… ìµœì¢… ì›”ì„¸ ë˜ëŠ” ì „ì„¸ í‰ê· ê°€ ì¶œë ¥
            let avgPriceText = generateAvgPriceText(filteredData, selectedTransaction, selectedRegion);
            applyFadeEffect("final-price-analysis", avgPriceText);
        }

        // ğŸ“Œ ë¶„ì„ ê²°ê³¼ ìƒì„± í•¨ìˆ˜ (ì „ì„¸ / ì›”ì„¸ êµ¬ë¶„)
        function generateAnalysisText(data, transactionType) {
            if (data.length === 0) {
                return `ğŸš« **${transactionType} ë°ì´í„° ì—†ìŒ**`;
            }

            let yearlyPrice = {};
            let yearlyCount = {};
            let totalPrice = 0;
            let totalCount = 0;
            let priceKey = transactionType === "ì „ì„¸" ? "ë³´ì¦ê¸ˆ(ë§Œì›)" : "ì„ëŒ€ë£Œ(ë§Œì›)";

            data.forEach(row => {
                let price = parseFloat(row[priceKey]);
                if (price > 0) {
                    if (!yearlyPrice[row["ë…„ë„"]]) {
                        yearlyPrice[row["ë…„ë„"]] = 0;
                        yearlyCount[row["ë…„ë„"]] = 0;
                    }
                    yearlyPrice[row["ë…„ë„"]] += price;
                    yearlyCount[row["ë…„ë„"]]++;

                    totalPrice += price;
                    totalCount++;
                }
            });

            Object.keys(yearlyPrice).forEach(year => {
                yearlyPrice[year] = (yearlyPrice[year] / yearlyCount[year]).toFixed(2);
            });

            let trendText = "ë°ì´í„° ë¶€ì¡±";
            let trendIcon = "â“";
            let trendAdvice = "";

            if (yearlyPrice["2022"] && yearlyPrice["2023"] && yearlyPrice["2024"]) {
                let diff1 = yearlyPrice["2023"] - yearlyPrice["2022"];
                let diff2 = yearlyPrice["2024"] - yearlyPrice["2023"];
                
                if (diff1 > 0 && diff2 > 0) {
                    trendText = "ê³„ì† ìƒìŠ¹ ì¤‘";
                    trendIcon = "ğŸ“ˆ";
                    trendAdvice = "ì•ìœ¼ë¡œë„ ê°€ê²©ì´ ìƒìŠ¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë‹ˆ ì €ë ´í•œ ë‹¤ë¥¸ ë§¤ë¬¼ì„ ê³„ì•½í•˜ëŠ” ê²ƒì´ ìœ ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!";
                } else if (diff1 < 0 && diff2 < 0) {
                    trendText = "ê³„ì† í•˜ë½ ì¤‘";
                    trendIcon = "ğŸ“‰";
                    trendAdvice = "ë§¤ë¬¼ì´ ì´ì „ì˜ ê²½ìš°ë³´ë‹¤ ì €ë ´í•´ì§€ê³  ìˆìœ¼ë‹ˆ ì§€ê¸ˆ ê³„ì•½í•˜ëŠ”ê²Œ ì¢‹ì€ ì„ íƒì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤!";
                } else {
                    trendText = "ë³€ë™ì„± ìˆìŒ";
                    trendIcon = "ğŸ”„";
                    trendAdvice = "ê°€ê²© ë³€ë™ì´ ìˆìœ¼ë‹ˆ ë‹¤ì–‘í•œ ë§¤ë¬¼ì„ ë¹„êµí•´ë³´ê³  ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”!";
                }
            }

            return `
                <strong> ${trendIcon} ${transactionType} ì‹œì„¸ ë¶„ì„ </strong> <br>
                2022ë…„: ${yearlyPrice["2022"] ? yearlyPrice["2022"] + "ë§Œ ì›" : "ë°ì´í„° ì—†ìŒ"}<br>
                2023ë…„: ${yearlyPrice["2023"] ? yearlyPrice["2023"] + "ë§Œ ì›" : "ë°ì´í„° ì—†ìŒ"}<br>
                2024ë…„: ${yearlyPrice["2024"] ? yearlyPrice["2024"] + "ë§Œ ì›" : "ë°ì´í„° ì—†ìŒ"}<br>
                í˜„ì¬ ${trendText} ìƒíƒœì…ë‹ˆë‹¤. ${trendAdvice}
            `; 
        }

        function generateDepositRentRatio(data, selectedRegion) {
            let ratioData = {};

            data.forEach(row => {
                if (row["ë³´ì¦ê¸ˆ(ë§Œì›)"] && row["ì„ëŒ€ë£Œ(ë§Œì›)"]) {
                    let ratio = parseFloat(row["ì„ëŒ€ë£Œ(ë§Œì›)"]) / parseFloat(row["ë³´ì¦ê¸ˆ(ë§Œì›)"]);
                    ratioData[row["ë²•ì •ë™ëª…"]] = ratio;
                }
            });

            let sortedRatio = Object.entries(ratioData).sort((a, b) => b[1] - a[1]);

            let ratioText = `ğŸ’¸ <strong> ${selectedRegion} ë³´ì¦ê¸ˆ ëŒ€ë¹„ ì›”ì„¸ ë¹„ìœ¨ </strong> <br>`;
            if (sortedRatio.length > 0) {
                let ratioVal = sortedRatio[0][1] * 100; // ë¹„ìœ¨ì„ í¼ì„¼íŠ¸ë¡œ ë³€í™˜
                ratioText += `í˜„ì¬ ë³´ì¦ê¸ˆ ëŒ€ë¹„ ì›”ì„¸ ë¹„ìœ¨ì€ <span class="highlight"> ${ratioVal.toFixed(2)}%</span>ì…ë‹ˆë‹¤.<br>`;
                // ì¡°ê±´ì— ë”°ë¼ ë©”ì‹œì§€ ì¶”ê°€
                if (parseFloat(ratioVal.toFixed(2)) === 5.50) {
                    ratioText += "ë³´ì¦ê¸ˆ ëŒ€ë¹„ ì›”ì„¸ì˜ ì „í™˜ìœ¨ì´ ì ì •ìˆ˜ì¤€ì…ë‹ˆë‹¤!<br><br><span style='font-size:12px;'>ì „ì›”ì„¸ë³€í™˜ìœ¨ = ë³´ì¦ê¸ˆ * [ê¸°ì¤€ê¸ˆë¦¬(3.5) + ì´ìœ¨(2)]</span>";
                } else if (parseFloat(ratioVal.toFixed(2)) > 5.50) {
                    ratioText += "ë³´ì¦ê¸ˆ ëŒ€ë¹„ ì›”ì„¸ì˜ ì „í™˜ìœ¨ì´ ë³´í¸ì ì¸ ì›”ì„¸ì „í™˜ìœ¨ ìˆ˜ì¤€ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤. ë³´ì¦ê¸ˆì— ë¹„í•´ ë‹¤ì†Œ ë†’ì€ ê°€ê²©ì˜ ì›”ì„¸ì…ë‹ˆë‹¤!<br><br><span style='font-size:12px;'>ì „ì›”ì„¸ë³€í™˜ìœ¨ = ë³´ì¦ê¸ˆ * [ê¸°ì¤€ê¸ˆë¦¬(3.5) + ì´ìœ¨(2)]</span>";
                } else {
                    ratioText += "ë³´ì¦ê¸ˆ ëŒ€ë¹„ ì›”ì„¸ì˜ ì „í™˜ìœ¨ì´ ë³´í¸ì ì¸ ì›”ì„¸ì „í™˜ìœ¨ ìˆ˜ì¤€ë³´ë‹¤ ì €ë ´í•œ í¸ì…ë‹ˆë‹¤. ë³´ì¦ê¸ˆì— ë¹„í•´ ì›”ì„¸ì˜ ë¶€ë‹´ì´ ì ì€ ì§€ì—­ì…ë‹ˆë‹¤!<br><br><span style='font-size:12px;'>ì „ì›”ì„¸ë³€í™˜ìœ¨ = ë³´ì¦ê¸ˆ * [ê¸°ì¤€ê¸ˆë¦¬(3.5) + ì´ìœ¨(2)]</span>";
                }
            } else {
                ratioText += "ë°ì´í„° ì—†ìŒ";
            }

            return ratioText;
        }

        // ğŸ“Œ ìµœì¢… ì›”ì„¸/ì „ì„¸ í‰ê· ê°€ í…ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜
        function generateAvgPriceText(data, transactionType, selectedRegion) {
            let totalPrice = 0, totalCount = 0;
            let priceKey = transactionType === "ì „ì„¸" ? "ë³´ì¦ê¸ˆ(ë§Œì›)" : "ì„ëŒ€ë£Œ(ë§Œì›)";

            data.forEach(row => {
                let price = parseFloat(row[priceKey]);
                if (price > 0) {
                    totalPrice += price;
                    totalCount++;
                }
            });

            let avgPrice = totalCount > 0 ? (totalPrice / totalCount).toFixed(2) : "ë°ì´í„° ì—†ìŒ";

            return `ğŸ  <strong> ${selectedRegion} ${transactionType} í‰ê·  ì‹œì„¸ </strong> <br>
                í˜„ì¬ ${selectedRegion}ì˜ í‰ê·  ${transactionType}ëŠ” <span class="highlight"> ${avgPrice} </span>ë§Œ ì›ì…ë‹ˆë‹¤.<br>
                ${transactionType === "ì›”ì„¸" ? "ë§¤ë‹¬ ë‚´ì•¼ í•˜ëŠ” ë¶€ë‹´ì„ ê³ ë ¤í•´ì„œ ì‹ ì¤‘íˆ ì„ íƒí•˜ì„¸ìš”!" : "ë³´ì¦ê¸ˆì„ ì˜ ê³ ë ¤í•˜ì—¬ ì ì ˆí•œ ë§¤ë¬¼ì„ ì°¾ì•„ë³´ì„¸ìš”!"}`;
        }
        

        // ğŸ“Œ í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì ìš© (fade-in íš¨ê³¼)
        function applyFadeEffect(elementId, newText) {
            const element = document.getElementById(elementId);
            
            if (!element) return; // ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ

            if (!newText.trim()) {
                element.style.display = "none"; // í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ìˆ¨ê¸°ê¸°
            } else {
                element.style.display = "block"; // í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë³´ì´ê¸°
                element.style.opacity = 0;
                setTimeout(() => {
                    element.innerHTML = newText;
                    element.style.opacity = 1;
                }, 300);
                "conversion-rate",
                "ì „ì›”ì„¸ë³€í™˜ìœ¨ = ë³´ì¦ê¸ˆ * [ê¸°ì¤€ê¸ˆë¦¬(3.5) + ì´ìœ¨(2)]"
            }
        }

        window.onload = function() {
            applyFadeEffect("rent-analysis", "");
            applyFadeEffect("yearly-trend-analysis", "");
            applyFadeEffect("deposit-rent-analysis", "");
            applyFadeEffect("final-price-analysis", "");
        };


        document.addEventListener("DOMContentLoaded", loadCSVData);
        document.querySelectorAll("select").forEach(select => select.addEventListener("change", () => {
            checkSelections();
            updateAnalysisTitle();
            updatePriceChart();
            updateTextAnalysis();
        }));
    </script>
</body>
</html>