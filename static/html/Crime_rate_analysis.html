<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìš¸ì‹œ ìì¹˜êµ¬ë³„ ë²”ì£„ ë¶„ì„</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 800px;
            margin: auto;
        }
        .chart-container {
            margin-top: 20px;
            display: none;
        }
        canvas {
            max-width: 100%;
            margin: auto;
        }
        table {
            width: 80%;
            margin: 10px auto;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        .analysis-box {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            text-align: left;
            border-left: 4px solid #4682b4;
        }
        .trend-up {
            color: #cc0000;
        }
        .trend-down {
            color: #008800;
        }
        .highlight {
            font-weight: bold;
            background-color: #ffffcc;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>ğŸ“Š ì„œìš¸ì‹œ ìì¹˜êµ¬ë³„ ë²”ì£„ ë¶„ì„</h1>
    <div class="container">
        <div class="chart-container" id="crimeTrendContainer">
            <h3>ì—°ë„ë³„ ë²”ì£„ ë°œìƒ ì¶”ì´</h3>
            <canvas id="crimeChart"></canvas>
            <div class="analysis-box" id="crimeTrendAnalysis">
                <h4>ğŸ“Š ë²”ì£„ ë°œìƒ ì¶”ì´ ë¶„ì„</h4>
                <p id="crimeTrend"></p>
                <p id="crimeYearComparison"></p>
                <p id="crimeGrowth"></p>
            </div>
        </div>

        <div class="chart-container" id="crimeTypeContainer">
            <h3>ë²”ì£„ ìœ í˜•ë³„ ë¹„ìœ¨</h3>
            <canvas id="crimeTypeChart"></canvas>
            <table id="crimeTable">
                <thead>
                    <tr>
                        <th>ë²”ì£„ ìœ í˜•</th>
                        <th>ê±´ìˆ˜</th>
                        <th>ë¹„ìœ¨ (%)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="analysis-box">
                <h4>ğŸ“Š ë²”ì£„ ìœ í˜•ë³„ ë¶„ì„</h4>
                <p id="dominantCrimeType"></p>
                <p id="crimeDistribution"></p>
                <p id="crimeTypeInsight"></p>
            </div>
        </div>
    </div>

    <script>
        let crimeChart = null;
        let typeChart = null;
        let colors = {
            "trend": "rgba(255, 99, 132, 1)",
            "background": "rgba(255, 99, 132, 0.2)",
            "crimeTypes": ["#FFB6C1", "#FFDAB9", "#FFFACD", "#B0E0E6", "#D8BFD8", "#98FB98"]
        };
        console.log("ì°¨íŠ¸ ê°ì²´ ìƒíƒœ:", typeof crimeChart, crimeChart);
        document.addEventListener("DOMContentLoaded", function() {
            function waitForDistrictSelect(callback) {
                let districtSelect = parent.document.getElementById("district-select");

                if (districtSelect) {
                    callback(districtSelect);
                } else {
                    console.warn("âš ï¸ 'district-select' ìš”ì†Œê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„ ì¤‘...");
                    setTimeout(() => waitForDistrictSelect(callback), 500);
                }
            }

            waitForDistrictSelect(function(districtSelect) {
                console.log("âœ… 'district-select' ìš”ì†Œê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");

                crimeDataset = {}; // âœ… ì „ì—­ ë³€ìˆ˜ ì„ ì–¸

                // âœ… JSON íŒŒì¼ ë¡œë“œ (í•œ ë²ˆë§Œ ìˆ˜í–‰)
                fetch("/static/data/crime_data.json")
                    .then(response => response.json())
                    .then(data => {
                        crimeDataset = data;

                        let savedDistrict = sessionStorage.getItem("selectedDistrict");
                        if (savedDistrict) {
                            console.log("ğŸ“Œ ì €ì¥ëœ êµ¬ ë¶ˆëŸ¬ì˜¤ê¸°:", savedDistrict);
                            districtSelect.value = savedDistrict;
                            updateChartsByDistrict(savedDistrict);
                        }
                    })
                    .catch(error => console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ", error));

                // âœ… `district-select` ê°’ì´ ë³€ê²½ë  ë•Œ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                districtSelect.addEventListener("change", function() {
                    let selectedDistrict = districtSelect.value;

                    if (!selectedDistrict) {
                        console.warn("âš ï¸ 'district-select' ê°’ì´ ë¹„ì–´ ìˆì–´ updateChartsByDistrict ì‹¤í–‰ ì•ˆí•¨.");
                        return;
                    }

                    sessionStorage.setItem("selectedDistrict", selectedDistrict);
                    updateChartsByDistrict(selectedDistrict);
                });
            });
        });

        // âœ… ì„ íƒí•œ êµ¬ë¥¼ ì´ìš©í•˜ì—¬ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateChartsByDistrict(selectedDistrict) {
            if (!selectedDistrict) {
                console.warn("âš ï¸ 'district-select' ê°’ì´ ì—†ìŠµë‹ˆë‹¤. updateCharts ì‹¤í–‰ ì•ˆí•¨.");
                return;
            }

            if (!crimeDataset[selectedDistrict]) {
                console.error("âŒ JSON ë°ì´í„°ì—ì„œ í•´ë‹¹ êµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", selectedDistrict);
                document.querySelectorAll(".chart-container").forEach(el => el.style.display = "none");
                return;
            }

            let data = crimeDataset[selectedDistrict];

            if (!data) {
                console.error("âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. selectedDistrict:", selectedDistrict);
                return;
            }

            console.log("âœ… ë§¤ì¹­ëœ êµ¬ ë°ì´í„°:", selectedDistrict, data);
            
            document.querySelectorAll(".chart-container").forEach(el => el.style.display = "block");
            updateCharts(data, selectedDistrict);
        }

        function updateCharts(data, districtName) {
            if (!data) {
                console.error("âŒ updateCharts: ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ ì•ˆí•¨.");
                return;
            }

            let crimeChartContainer = document.getElementById('crimeChart');
            let typeChartContainer = document.getElementById('crimeTypeChart');

            if (!crimeChartContainer || !typeChartContainer) {
                console.error("âŒ ì°¨íŠ¸ ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (typeof crimeChart !== 'undefined' && crimeChart !== null) {
                crimeChart.destroy();
            }
            if (typeof typeChart !== 'undefined' && typeChart !== null) {
                typeChart.destroy();
            }

            // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆë“¤ í‘œì‹œ
            document.querySelectorAll(".chart-container").forEach(el => el.style.display = "block");

            // ë²”ì£„ ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateCrimeTrendChart(data, districtName);
            
            // ë²”ì£„ ìœ í˜• ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateCrimeTypeChart(data, districtName);
            
            // ë¶„ì„ ë‚´ìš© ì—…ë°ì´íŠ¸
            analyzeCrimeTrend(data, districtName);
            analyzeCrimeTypes(data, districtName);
        }

        function updateCrimeTrendChart(data, districtName) {
            let ctx = document.getElementById('crimeChart').getContext('2d');
            if (!ctx) {
                console.error("âŒ 'crimeChart' ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const years = Object.keys(data[Object.keys(data)[0]]).sort();
            const totalCrimes = years.map(year =>
                Object.values(data).reduce((acc, cur) => acc + (cur[year] || 0), 0)
            );

            crimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: `${districtName} ë²”ì£„ ë°œìƒ ê±´ìˆ˜`,
                        data: totalCrimes,
                        borderColor: colors.trend,
                        backgroundColor: colors.background,
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        function updateCrimeTypeChart(data, districtName) {
            let ctx = document.getElementById('crimeTypeChart').getContext('2d');
            if (!ctx) {
                console.error("âŒ 'crimeTypeChart' ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const latestYear = Object.keys(Object.values(data)[0]).sort().pop();
            const latestData = Object.keys(data).reduce((acc, key) => {
                acc[key] = data[key][latestYear] || 0;
                return acc;
            }, {});
            const total = Object.values(latestData).reduce((a, b) => a + b, 0);

            typeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(latestData),
                    datasets: [{
                        data: Object.values(latestData),
                        backgroundColor: colors.crimeTypes
                    }]
                },
                options: {
                    plugins: {
                        datalabels: {
                            formatter: (value) => `${((value / total) * 100).toFixed(1)}%`,
                            color: "#000",
                            font: { weight: "bold", size: 20 },
                            anchor: 'end',
                            align: 'start',
                            offset: 6
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateCrimeTable(latestData, total);
        }

        function updateCrimeTable(latestData, total) {
            const tableBody = document.getElementById("crimeTable").getElementsByTagName("tbody")[0];
            tableBody.innerHTML = "";
            
            Object.keys(latestData).forEach(type => {
                const count = latestData[type];
                const percentage = ((count / total) * 100).toFixed(1);
                
                let row = `<tr>
                    <td>${type}</td>
                    <td>${count}ê±´</td>
                    <td>${percentage}%</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function analyzeCrimeTrend(data, districtName) {
            const years = Object.keys(data[Object.keys(data)[0]]).sort();
            const totalCrimes = years.map(year =>
                Object.values(data).reduce((acc, cur) => acc + (cur[year] || 0), 0)
            );
            
            // ìµœê·¼ ì¶”ì„¸ ë¶„ì„
            const latestDiff = totalCrimes[totalCrimes.length-1] - totalCrimes[totalCrimes.length-2];
            const crimeTrend = latestDiff > 0 ? "ì¦ê°€" : (latestDiff < 0 ? "ê°ì†Œ" : "ìœ ì§€");
            const trendClass = latestDiff > 0 ? "trend-up" : (latestDiff < 0 ? "trend-down" : "");
            
            // ì²« í•´ì™€ ë§ˆì§€ë§‰ í•´ ë¹„êµ
            const firstYearTotal = totalCrimes[0];
            const lastYearTotal = totalCrimes[totalCrimes.length-1];
            const overallDiff = lastYearTotal - firstYearTotal;
            const overallGrowth = ((overallDiff / firstYearTotal) * 100).toFixed(1);
            
            document.getElementById('crimeTrend').innerHTML = 
                `${districtName}ì˜ ë²”ì£„ ë°œìƒ ê±´ìˆ˜ëŠ” ìµœê·¼ <span class="${trendClass}">${crimeTrend}</span> ì¶”ì„¸ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.`;
            
            document.getElementById('crimeYearComparison').innerHTML = 
                `ìµœê·¼ ì—°ë„(${years[years.length-1]})ì˜ ë²”ì£„ ë°œìƒ ê±´ìˆ˜ëŠ” <span class="highlight">${lastYearTotal}ê±´</span>ìœ¼ë¡œ, ì´ì „ ì—°ë„(${years[years.length-2]})ì˜ ${totalCrimes[totalCrimes.length-2]}ê±´ ëŒ€ë¹„ <span class="${trendClass}">${Math.abs(latestDiff)}ê±´ ${crimeTrend}</span>í–ˆìŠµë‹ˆë‹¤.`;
            
            document.getElementById('crimeGrowth').innerHTML = 
                `${years[0]}ë…„ë¶€í„° ${years[years.length-1]}ë…„ê¹Œì§€ ë²”ì£„ ë°œìƒ ê±´ìˆ˜ëŠ” <span class="highlight">${overallGrowth}%</span> ë³€í™”í–ˆìŠµë‹ˆë‹¤.`;
        }
            
            function analyzeCrimeTypes(data, districtName) {
        const latestYear = Object.keys(Object.values(data)[0]).sort().pop();
        const latestData = Object.keys(data).reduce((acc, key) => {
            acc[key] = data[key][latestYear] || 0;
            return acc;
        }, {});

        const total = Object.values(latestData).reduce((a, b) => a + b, 0);

        // ê°€ì¥ ë§ì´ ë°œìƒí•œ ë²”ì£„ ìœ í˜• ì°¾ê¸°
        let maxCrimeType = "";
        let maxCrimeCount = 0;

        for (const type in latestData) {
            if (latestData[type] > maxCrimeCount) {
                maxCrimeCount = latestData[type];
                maxCrimeType = type;
            }
        }

        // ë²”ì£„ ìœ í˜•ë³„ ì£¼ìš” ë¹„ìœ¨ ê³„ì‚°
        let crimeInsights = [];
        for (const type in latestData) {
            let percentage = ((latestData[type] / total) * 100).toFixed(1);
            crimeInsights.push(`${type}: <span class="highlight">${percentage}%</span>`);
        }

        document.getElementById('dominantCrimeType').innerHTML = 
            `ìµœê·¼ ê°€ì¥ ë§ì´ ë°œìƒí•œ ë²”ì£„ ìœ í˜•ì€ <span class="highlight">${maxCrimeType}</span>ì´ë©°, ì´ <span class="highlight">${maxCrimeCount}ê±´</span>ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`;

        document.getElementById('crimeDistribution').innerHTML = 
            `${districtName}ì—ì„œ ë°œìƒí•œ ë²”ì£„ ìœ í˜•ë³„ ë¹„ìœ¨: ${crimeInsights.join(", ")}.`;

        document.getElementById('crimeTypeInsight').innerHTML = 
            `ì „ì²´ì ìœ¼ë¡œ ${districtName}ì—ì„œëŠ” <span class="highlight">${maxCrimeType}</span>ì´ ê°€ì¥ ìš°ì„¸í•˜ë©°, ë²”ì£„ ì˜ˆë°©ì„ ìœ„í•œ ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
    }

    // âœ… ì„ íƒí•œ êµ¬ë¥¼ ì´ìš©í•˜ì—¬ ê·¸ë˜í”„ ë° ë¶„ì„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateChartsByDistrict(selectedDistrict) {
        if (!selectedDistrict) {
            console.warn("âš ï¸ 'district-select' ê°’ì´ ì—†ìŠµë‹ˆë‹¤. updateCharts ì‹¤í–‰ ì•ˆí•¨.");
            return;
        }

        if (!crimeDataset[selectedDistrict]) {
            console.error("âŒ JSON ë°ì´í„°ì—ì„œ í•´ë‹¹ êµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", selectedDistrict);
            document.querySelectorAll(".chart-container").forEach(el => el.style.display = "none");
            return;
        }

        let data =crimeDataset[selectedDistrict];

        if (!data) {
            console.error("âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. selectedDistrict:", selectedDistrict);
            return;
        }

        console.log("âœ… ë§¤ì¹­ëœ êµ¬ ë°ì´í„°:", selectedDistrict, data);
        
        document.querySelectorAll(".chart-container").forEach(el => el.style.display = "block");
        updateCharts(data, selectedDistrict);
    }

    function updateCharts(data, districtName) {
        if (!data) {
            console.error("âŒ updateCharts: ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰ ì•ˆí•¨.");
            return;
        }

        let crimeChartContainer = document.getElementById('crimeChart');
        let typeChartContainer = document.getElementById('crimeTypeChart');

        if (!crimeChartContainer || !typeChartContainer) {
            console.error("âŒ ì°¨íŠ¸ ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        if (crimeChart) crimeChart.destroy();
        if (typeChart) typeChart.destroy();

        // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆë“¤ í‘œì‹œ
        document.querySelectorAll(".chart-container").forEach(el => el.style.display = "block");

        // ë²”ì£„ ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateCrimeTrendChart(data, districtName);
        
        // ë²”ì£„ ìœ í˜• ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateCrimeTypeChart(data, districtName);
        
        // ë¶„ì„ ë‚´ìš© ì—…ë°ì´íŠ¸
        analyzeCrimeTrend(data, districtName);
        analyzeCrimeTypes(data, districtName);
    }

    function updateCrimeTrendChart(data, districtName) {
        let ctx = document.getElementById('crimeChart').getContext('2d');
        if (!ctx) {
            console.error("âŒ 'crimeChart' ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const years = Object.keys(data[Object.keys(data)[0]]).sort();
        const totalCrimes = years.map(year =>
            Object.values(data).reduce((acc, cur) => acc + (cur[year] || 0), 0)
        );

        crimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [{
                    label: `${districtName} ë²”ì£„ ë°œìƒ ê±´ìˆ˜`,
                    data: totalCrimes,
                    borderColor: "rgba(255, 99, 132, 1)",
                    backgroundColor: "rgba(255, 99, 132, 0.2)",
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: false }
                },
                plugins: {
                    legend: { display: false } // âœ… ìˆ«ì ê°’ ì œê±°
                }
            }
        });
    }

    function updateCrimeTypeChart(data, districtName) {
        let ctx = document.getElementById('crimeTypeChart').getContext('2d');
        if (!ctx) {
            console.error("âŒ 'crimeTypeChart' ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const latestYear = Object.keys(Object.values(data)[0]).sort().pop();
        const latestData = Object.keys(data).reduce((acc, key) => {
            acc[key] = data[key][latestYear] || 0;
            return acc;
        }, {});
        const total = Object.values(latestData).reduce((a, b) => a + b, 0);

        typeChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(latestData),
                datasets: [{
                    data: Object.values(latestData),
                    backgroundColor: ["#FFB6C1", "#FFDAB9", "#FFFACD", "#B0E0E6", "#D8BFD8"]
                }]
            },
            options: {
                plugins: {
                    datalabels: {
                        formatter: (value) => `${((value / total) * 100).toFixed(1)}%`,
                        color: "#000",
                        font: { weight: "bold", size: 20 },
                        anchor: 'end',
                        align: 'start',
                        offset: 6
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        // âœ… ë²”ì£„ ìœ í˜•ë³„ ë°ì´í„° í…Œì´ë¸” ì—…ë°ì´íŠ¸
        updateCrimeTable(latestData, total);
    }

    function updateCrimeTable(latestData, total) {
        const tableBody = document.getElementById("crimeTable").getElementsByTagName("tbody")[0];
        tableBody.innerHTML = "";
        
        Object.keys(latestData).forEach(type => {
            const count = latestData[type];
            const percentage = ((count / total) * 100).toFixed(1);
            
            let row = `<tr>
                <td>${type}</td>
                <td>${count}ê±´</td>
                <td>${percentage}%</td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    }
</script>
</body>
</html>