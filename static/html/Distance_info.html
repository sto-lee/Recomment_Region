<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï£ºÎ≥Ä ÏãúÏÑ§ Í±∞Î¶¨ Ï†ïÎ≥¥</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 800px;
            margin: auto;
        }
        .facility-group {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .facility-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .facility-item:last-child {
            border-bottom: none;
        }
        .distance-badge {
            background-color: #4682b4;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        .close-distance {
            background-color: #2ecc71;
        }
        .medium-distance {
            background-color: #f1c40f;
        }
        .far-distance {
            background-color: #e74c3c;
        }
        .facility-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }
        .facility-info {
            display: flex;
            align-items: center;
        }
        .analysis-box {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            text-align: left;
            border-left: 4px solid #4682b4;
        }
        .facility-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .facility-type-header h4 {
            margin: 0;
            font-size: 1rem;
            color: #495057;
        }
        .count-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .count-slider {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            background: #e9ecef;
            border-radius: 2px;
            outline: none;
        }
        .count-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #4682b4;
            border-radius: 50%;
            cursor: pointer;
        }
        .count-value {
            min-width: 20px;
            text-align: right;
            color: #4682b4;
            font-weight: bold;
        }
        .facilities-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üèÉ‚Äç‚ôÇÔ∏è ÎèÑÎ≥¥ Í±∞Î¶¨ Ï†ïÎ≥¥</h1>
    <div class="container">
        <div id="facilityDistances">
            <!-- Îç∞Ïù¥ÌÑ∞Îäî JavaScriptÎ°ú ÎèôÏ†Å ÏÉùÏÑ±Îê® -->
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        let currentData = null;

        // ÏãúÏÑ§Î≥Ñ ÏÉÅÏúÑ NÍ∞ú Ìï≠Î™© Ï∂îÏ∂ú (NÏùÄ ÏÑ†ÌÉù Í∞ÄÎä•)
        function getTopNFacilities(data, facilityType, n = 5) {
            if (!data.facilities[facilityType]) return [];
            return data.facilities[facilityType]
                .sort((a, b) => a.distance - b.distance)
                .slice(0, n)
                .map(item => ({
                    name: item[`${facilityType}_name`],
                    type: item[`${facilityType}_type`],
                    distance: (item.distance / 1000).toFixed(2),
                    walking_time: item.walking_time
                }));
        }

        // Í±∞Î¶¨Ïóê Îî∞Î•∏ Î∞∞ÏßÄ ÌÅ¥ÎûòÏä§ Í≤∞Ï†ï
        function getDistanceClass(distance) {
            if (distance <= 0.5) return 'close-distance';
            if (distance <= 1) return 'medium-distance';
            return 'far-distance';
        }

        // ÏãúÏÑ§ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        async function updateFacilityDistances(center, level) {
            const container = document.getElementById('facilityDistances');
            container.innerHTML = '';

            try {
                // JSON ÌååÏùº Í≤ΩÎ°ú ÏÉùÏÑ±
                const fileName = `cluster_${center.lat}_${center.lng}.json`;
                const folderName = level <= 3 ? 'cluster_json_zoom3_with_walking_time' : 'cluster_json_zoom4_with_walking_time';
                const response = await fetch(`/static/data/dataset/walking_distance/${folderName}/${fileName}`);
                
                // ÌååÏùºÏù¥ ÏóÜÎäî Í≤ΩÏö∞ Ï≤òÎ¶¨
                if (!response.ok) {
                    throw new Error('Ìï¥Îãπ ÏúÑÏπòÏùò Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }

                const data = await response.json();
                // Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
                currentData = data;
                
                // Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏
                if (!data || !data.facilities) {
                    throw new Error('Ïò¨Î∞îÎ•∏ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.');
                }

                // ÏãúÏÑ§ Ï¢ÖÎ•òÎ≥ÑÎ°ú Í∑∏Î£πÌôî
                const facilityGroups = {
                    "ÍµêÌÜµ": {types: ["subway", "bus", "park_station"], names: ["ÏßÄÌïòÏ≤†", "Î≤ÑÏä§Ï†ïÎ•òÏû•", "Ï£ºÏ∞®Ïû•"]},
                    "Ìé∏ÏùòÏãúÏÑ§": {types: ["convenience_store", "electric_gas_station", "gas_station", "supermarket", "self_laundromat"], names: ["Ìé∏ÏùòÏ†ê", "Ï†ÑÍ∏∞ Ï∂©Ï†ÑÏÜå", "Ï£ºÏú†ÏÜå", "ÎßàÌä∏", "ÏÖÄÌîÑ Îπ®ÎûòÎ∞©"]},
                    "ÏùòÎ£å/ÏïàÏ†Ñ": {types: ["hospital", "police_office", "public_health_center"], names: ["Î≥ëÏõê", "Í≤ΩÏ∞∞ÏÑú", "Î≥¥Í±¥ÏÜå"]},
                    "ÍµêÏú°": {types: ["university", "school", "education", "daycare"], names: ["ÎåÄÌïô", "ÌïôÍµê", "ÍµêÏú°Í∏∞Í¥Ä", "Ïñ¥Î¶∞Ïù¥Ïßë"]},
                    "Ïó¨Í∞Ä": {types: ["park", "fitness", "theater", "music_room", "pc_room", "outdorr_sports"], names: ["Í≥µÏõê", "Ïö¥ÎèôÏãúÏÑ§", "ÏòÅÌôîÍ¥Ä", "ÎÖ∏ÎûòÎ∞©", "PCÎ∞©", "ÏïºÏô∏ Ïä§Ìè¨Ï∏†"]},
                    "Í∏∞ÌÉÄ": {types: ["tax_office", "post_office", "community_center"], names: ["ÏÑ∏Î¨¥ÏÑú", "Ïö∞Ï≤¥Íµ≠", "Ï£ºÎØºÏÑºÌÑ∞"]}
                };

                for (const [groupName, group] of Object.entries(facilityGroups)) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'facility-group';
                    groupDiv.innerHTML = `<h3>${groupName}</h3>`;

                    let hasAnyFacilities = false;

                    group.types.forEach((type, index) => {
                        const facilityName = group.names[index];
                        const facilities = getTopNFacilities(data, type, 5); // Í∏∞Î≥∏Í∞í 5Í∞ú
                        
                        if (facilities.length > 0) {
                            hasAnyFacilities = true;
                            
                            // ÏãúÏÑ§ Ïú†Ìòï Ìó§ÎçîÏôÄ Í∞úÏàò ÏÑ†ÌÉù Î∞î Ï∂îÍ∞Ä
                            groupDiv.innerHTML += `
                                <div class="facility-type-header">
                                    <h4>${facilityName}</h4>
                                    <div class="count-selector">
                                        <input type="range" 
                                               min="5" 
                                               max="10" 
                                               value="5" 
                                               class="count-slider" 
                                               data-type="${type}"
                                               oninput="updateFacilityCount(this, '${type}')">
                                        <span class="count-value">5</span>Í∞ú
                                    </div>
                                </div>
                                <div id="facilities-${type}" class="facilities-container">
                                    ${facilities.map(facility => `
                                        <div class="facility-item">
                                            <div class="facility-info">
                                                <span>${facility.name}</span>
                                            </div>
                                            <div class="distance-info">
                                                <span class="distance-badge ${getDistanceClass(parseFloat(facility.distance))}">
                                                    ${facility.distance}km
                                                </span>
                                                <span class="text-sm text-gray-500 ml-2">
                                                    ${facility.walking_time}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    });

                    // ÏãúÏÑ§Ïù¥ ÌïòÎÇòÎùºÎèÑ ÏûàÎäî Í∑∏Î£πÎßå Ï∂îÍ∞Ä
                    if (hasAnyFacilities) {
                        container.appendChild(groupDiv);
                    }
                }

            } catch (error) {
                console.error('Error loading facility data:', error);
                container.innerHTML = `
                    <div class="error-message" style="text-align: center; padding: 20px; color: #e74c3c;">
                        <p>üö´ ${error.message || 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'}</p>
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            Îã§Î•∏ ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.
                        </p>
                    </div>
                `;
            }
        }

        // ÏãúÏÑ§ Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò ÏàòÏ†ï
        function updateFacilityCount(slider, type) {
            if (!currentData) return;

            const container = document.getElementById(`facilities-${type}`);
            const countValue = slider.parentElement.querySelector('.count-value');
            const selectedCount = parseInt(slider.value);
            
            countValue.textContent = selectedCount;
            
            // ÏÑ†ÌÉùÎêú Í∞úÏàòÎßåÌÅº ÏãúÏÑ§ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            const facilities = getTopNFacilities(currentData, type, selectedCount);
            
            // ÏãúÏÑ§ Î™©Î°ù HTML ÏÉùÏÑ±
            const facilitiesHTML = facilities.map(facility => `
                <div class="facility-item">
                    <div class="facility-info">
                        <span>${facility.name}</span>
                    </div>
                    <div class="distance-info">
                        <span class="distance-badge ${getDistanceClass(parseFloat(facility.distance))}">
                            ${facility.distance}km
                        </span>
                        <span class="text-sm text-gray-500 ml-2">
                            ${facility.walking_time}
                        </span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = facilitiesHTML;
        }

        // Î©îÏãúÏßÄ ÏàòÏã† Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        window.addEventListener('message', function(event) {
            if (event.data.type === 'updateDistances') {
                updateFacilityDistances(event.data.center, event.data.level);
            }
        });
    </script>
</body>
</html>