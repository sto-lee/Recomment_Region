<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë³€ ì‹œì„¤ ê±°ë¦¬ ì •ë³´</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 800px;
            margin: auto;
        }
        .facility-group {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .facility-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .facility-item:last-child {
            border-bottom: none;
        }
        .distance-badge {
            background-color: #4682b4;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        .close-distance {
            background-color: #2ecc71;
        }
        .medium-distance {
            background-color: #f1c40f;
        }
        .far-distance {
            background-color: #e74c3c;
        }
        .facility-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }
        .facility-info {
            display: flex;
            align-items: center;
        }
        .analysis-box {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            text-align: left;
            border-left: 4px solid #4682b4;
        }
        .facility-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .facility-type-header h4 {
            margin: 0;
            font-size: 1rem;
            color: #495057;
        }
        .count-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .count-slider {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            background: #e9ecef;
            border-radius: 2px;
            outline: none;
        }
        .count-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #4682b4;
            border-radius: 50%;
            cursor: pointer;
        }
        .count-value {
            min-width: 20px;
            text-align: right;
            color: #4682b4;
            font-weight: bold;
        }
        .facilities-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸƒâ€â™‚ï¸ ë„ë³´ ê±°ë¦¬ ì •ë³´</h1>
    <div class="container">
        <div id="facilityDistances">
            <!-- ë°ì´í„°ëŠ” JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ë°ì´í„° ì €ì¥
        let currentData = null;

        // ì‹œì„¤ë³„ ìƒìœ„ Nê°œ í•­ëª© ì¶”ì¶œ (Nì€ ì„ íƒ ê°€ëŠ¥)
        function getTopNFacilities(data, facilityType, n = 5) {
            if (!data.facilities[facilityType]) return [];
            return data.facilities[facilityType]
                .sort((a, b) => a.distance - b.distance)
                .slice(0, n)
                .map(item => ({
                    name: item[`${facilityType}_name`],
                    type: item[`${facilityType}_type`],
                    distance: (item.distance / 1000).toFixed(2),
                    walking_time: item.walking_time
                }));
        }

        // ê±°ë¦¬ì— ë”°ë¥¸ ë°°ì§€ í´ë˜ìŠ¤ ê²°ì •
        function getDistanceClass(distance) {
            if (distance <= 0.5) return 'close-distance';
            if (distance <= 1) return 'medium-distance';
            return 'far-distance';
        }

        // ì‹œì„¤ ì •ë³´ ì—…ë°ì´íŠ¸
        async function updateFacilityDistances(center, level) {
            const container = document.getElementById('facilityDistances');
            container.innerHTML = '';

            try {
                // JSON íŒŒì¼ ê²½ë¡œ ìƒì„±
                const fileName = `cluster_${center.lat}_${center.lng}.json`;
                const folderName = level <= 3 ? 'cluster_json_zoom3_with_walking_time' : 'cluster_json_zoom4_with_walking_time';
                const response = await fetch(`/static/data/dataset/walking_distance/${folderName}/${fileName}`);
                
                // íŒŒì¼ì´ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
                if (!response.ok) {
                    throw new Error('í•´ë‹¹ ìœ„ì¹˜ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();
                // ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                currentData = data;
                
                // ë°ì´í„° êµ¬ì¡° í™•ì¸
                if (!data || !data.facilities) {
                    throw new Error('ì˜¬ë°”ë¥¸ ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                }

                // ì‹œì„¤ ì¢…ë¥˜ë³„ë¡œ ê·¸ë£¹í™”
                const facilityGroups = {
                    "êµí†µ": {types: ["subway", "bus", "park_station"], names: ["ì§€í•˜ì² ", "ë²„ìŠ¤ì •ë¥˜ì¥", "ì£¼ì°¨ì¥"]},
                    "í¸ì˜ì‹œì„¤": {types: ["convenience_store", "electric_gas_station", "gas_station", "supermarket", "self_laundromat"], names: ["í¸ì˜ì ", "ì „ê¸° ì¶©ì „ì†Œ", "ì£¼ìœ ì†Œ", "ë§ˆíŠ¸", "ì…€í”„ ë¹¨ë˜ë°©"]},
                    "ì˜ë£Œ/ì•ˆì „": {types: ["hospital", "police_office", "public_health_center"], names: ["ë³‘ì›", "ê²½ì°°ì„œ", "ë³´ê±´ì†Œ"]},
                    "êµìœ¡": {types: ["university", "school", "education", "daycare"], names: ["ëŒ€í•™", "í•™êµ", "êµìœ¡ê¸°ê´€", "ì–´ë¦°ì´ì§‘"]},
                    "ì—¬ê°€": {types: ["park", "fitness", "theater", "music_room", "pc_room", "outdorr_sports"], names: ["ê³µì›", "ìš´ë™ì‹œì„¤", "ì˜í™”ê´€", "ë…¸ë˜ë°©", "PCë°©", "ì•¼ì™¸ ìŠ¤í¬ì¸ "]},
                    "ê¸°íƒ€": {types: ["tax_office", "post_office", "community_center"], names: ["ì„¸ë¬´ì„œ", "ìš°ì²´êµ­", "ì£¼ë¯¼ì„¼í„°"]}
                };

                for (const [groupName, group] of Object.entries(facilityGroups)) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'facility-group';
                    groupDiv.innerHTML = `<h3>${groupName}</h3>`;

                    let hasAnyFacilities = false;

                    group.types.forEach((type, index) => {
                        const facilityName = group.names[index];
                        const facilities = getTopNFacilities(data, type, 5); // ê¸°ë³¸ê°’ 5ê°œ
                        
                        if (facilities.length > 0) {
                            hasAnyFacilities = true;
                            
                            // ì‹œì„¤ ìœ í˜• í—¤ë”ì™€ ê°œìˆ˜ ì„ íƒ ë°” ì¶”ê°€
                            groupDiv.innerHTML += `
                                <div class="facility-type-header">
                                    <h4>${facilityName}</h4>
                                    <div class="count-selector">
                                        <input type="range" 
                                               min="5" 
                                               max="10" 
                                               value="5" 
                                               class="count-slider" 
                                               data-type="${type}"
                                               oninput="updateFacilityCount(this, '${type}')">
                                        <span class="count-value">5</span>ê°œ
                                    </div>
                                </div>
                                <div id="facilities-${type}" class="facilities-container">
                                    ${facilities.map(facility => `
                                        <div class="facility-item">
                                            <div class="facility-info">
                                                <span>${facility.name}</span>
                                            </div>
                                            <div class="distance-info">
                                                <span class="distance-badge ${getDistanceClass(parseFloat(facility.distance))}">
                                                    ${facility.distance}km
                                                </span>
                                                <span class="text-sm text-gray-500 ml-2">
                                                    ${facility.walking_time}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    });

                    // ì‹œì„¤ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ” ê·¸ë£¹ë§Œ ì¶”ê°€
                    if (hasAnyFacilities) {
                        container.appendChild(groupDiv);
                    }
                }

            } catch (error) {
                console.error('Error loading facility data:', error);
                container.innerHTML = `
                    <div class="error-message" style="text-align: center; padding: 20px; color: #e74c3c;">
                        <p>ğŸš« ${error.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            ë‹¤ë¥¸ í´ëŸ¬ìŠ¤í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
                        </p>
                    </div>
                `;
            }
        }

        // ì‹œì„¤ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ìˆ˜ì •
        function updateFacilityCount(slider, type) {
            if (!currentData) return;

            const container = document.getElementById(`facilities-${type}`);
            const countValue = slider.parentElement.querySelector('.count-value');
            const selectedCount = parseInt(slider.value);
            
            countValue.textContent = selectedCount;
            
            // ì„ íƒëœ ê°œìˆ˜ë§Œí¼ ì‹œì„¤ í‘œì‹œ ì—…ë°ì´íŠ¸
            const facilities = getTopNFacilities(currentData, type, selectedCount);
            
            // ì‹œì„¤ ëª©ë¡ HTML ìƒì„±
            const facilitiesHTML = facilities.map(facility => `
                <div class="facility-item">
                    <div class="facility-info">
                        <span>${facility.name}</span>
                    </div>
                    <div class="distance-info">
                        <span class="distance-badge ${getDistanceClass(parseFloat(facility.distance))}">
                            ${facility.distance}km
                        </span>
                        <span class="text-sm text-gray-500 ml-2">
                            ${facility.walking_time}
                        </span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = facilitiesHTML;
        }

        // ë©”ì‹œì§€ ìˆ˜ì‹  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('message', function(event) {
            if (event.data.type === 'updateDistances') {
                updateFacilityDistances(event.data.center, event.data.level);
            }
        });
    </script>
</body>
</html>